<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICON Royalty Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: #ffffff;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #0b1215;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
        }
        
        .login-form {
            background: #ffffff;
            padding: 40px;
            max-width: 400px;
            margin: 50px auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #0b1215;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            font-size: 1em;
        }
        
        input:focus {
            outline: none;
            border-color: #8a2be2;
        }
        
        .search-container {
            position: relative;
        }
        
        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #8a2be2;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 2500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .suggestions.active {
            display: block;
        }
        
        .suggestion {
            padding: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .suggestion:hover, .suggestion.highlighted {
            background: rgba(138, 43, 226, 0.1);
        }
        
        .no-results {
            padding: 12px;
            color: #999;
            font-style: italic;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #8a2be2 0%, #0b1215 100%);
            color: white;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .dashboard {
            display: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #ffffff;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            border: 2px solid transparent;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: #8a2be2;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #8a2be2;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .data-section {
            background: #ffffff;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .section-title {
            font-size: 1.5em;
            color: #0b1215;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #8a2be2;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #0b1215;
            border-bottom: 2px solid #e0e0e0;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            word-wrap: break-word;
            max-width: 300px;
        }
        
        tr:hover {
            background: rgba(138, 43, 226, 0.05);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #8a2be2 0%, #0b1215 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            float: right;
            transition: transform 0.2s;
        }
        
        .logout-btn:hover {
            transform: translateY(-2px);
        }
        
        .month-chart {
            height: 300px;
            margin-top: 20px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
        }
        
        .bar {
            background: linear-gradient(135deg, #8a2be2 0%, #0b1215 100%);
            flex: 1;
            margin: 0 5px;
            position: relative;
            min-height: 20px;
            transition: all 0.3s;
        }
        
        .bar:hover {
            opacity: 0.8;
        }
        
        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            white-space: nowrap;
        }
        
        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            white-space: nowrap;
        }
        
        .alert {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            background: white;
            margin: 50px auto;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8a2be2;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .search-hint {
            color: #666;
            font-size: 0.85em;
            margin-top: 5px;
            font-style: italic;
        }
        
        .table-search {
            margin-bottom: 20px;
        }
        
        .table-search input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
        }
        
        .table-search input:focus {
            border-color: #8a2be2;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .month-chart {
                height: 200px;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s;
            overflow-y: auto;
            padding: 20px 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 40px auto;
            padding: 40px;
            max-width: 500px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: slideDown 0.3s;
            position: relative;
            box-sizing: border-box;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            font-size: 1.8em;
            color: #0b1215;
            margin-bottom: 10px;
        }

        .modal-subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .close {
            color: #999;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
            transition: color 0.2s;
        }

        .close:hover {
            color: #333;
        }

        .change-password-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin-left: 10px;
            transition: transform 0.2s;
        }

        .change-password-btn:hover {
            transform: translateY(-2px);
        }

        .password-strength {
            margin-top: 8px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .strength-weak { color: #dc3545; }
        .strength-medium { color: #ffc107; }
        .strength-strong { color: #28a745; }

        /* Admin Tools Styling */
        #adminToolsPanel {
            background: #ffffff;
            margin-top: 20px;
        }

        #adminToolsPanel h2,
        #adminToolsPanel h3,
        #adminToolsPanel h4 {
            color: #0b1215;
        }

        #adminToolsPanel .subtitle {
            color: #666;
        }

        #selectedUserInfo {
            background: #f8f9fa;
            border: 2px solid #8a2be2;
            border-radius: 8px;
        }

        #allUsersTable {
            background: white;
            border-radius: 8px;
        }

        #allUsersTable table {
            width: 100%;
        }

        #allUsersTable code {
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #8a2be2;
            font-weight: 600;
        }

        /* Collapsible Section Styling */
        .collapsible-header {
            background: #f8f9fa;
            padding: 15px 20px;
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
            margin-bottom: 10px;
            border: 2px solid #e0e0e0;
        }

        .collapsible-header:hover {
            background: #e9ecef;
        }

        .collapsible-header h3 {
            margin: 0;
            color: #0b1215;
        }

        .collapsible-icon {
            font-size: 1.2em;
            transition: transform 0.3s;
        }

        .collapsible-icon.open {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.open {
            max-height: none;
            overflow: visible;
            transition: none;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                max-width: 100%;
            }

            /* Header adjustments */
            .header {
                padding: 20px 15px;
                margin-bottom: 15px;
            }

            h1 {
                font-size: 1.5em;
            }

            .subtitle {
                font-size: 0.9em;
            }

            /* Stats grid - stack on mobile */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin-bottom: 20px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 1.8em;
            }

            .stat-label {
                font-size: 0.8em;
            }

            /* Data sections */
            .data-section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .section-title {
                font-size: 1.2em;
                margin-bottom: 15px;
            }

            /* Bar chart - make scrollable horizontally */
            .month-chart {
                height: 250px;
                overflow-x: auto;
                overflow-y: hidden;
                min-width: 100%;
                padding-bottom: 35px;
            }

            .bar {
                min-width: 40px;
                margin: 0 3px;
            }

            .bar-label {
                font-size: 0.7em;
                bottom: -30px;
                transform: translateX(-50%) rotate(-45deg);
                transform-origin: center;
                white-space: nowrap;
            }

            .bar-value {
                font-size: 0.75em;
                top: -20px;
            }

            /* Tables - horizontal scroll */
            .table-container,
            div[style*="overflow-x: auto"] {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 600px;
            }

            th, td {
                padding: 8px;
                font-size: 0.85em;
            }

            /* Forms */
            .login-form {
                padding: 25px;
                max-width: 100%;
                margin: 20px auto;
            }

            .form-group {
                margin-bottom: 15px;
            }

            input {
                padding: 10px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            /* Buttons - touch-friendly */
            .btn {
                padding: 12px 20px;
                font-size: 16px;
                min-height: 44px; /* iOS touch target */
            }

            .export-btn {
                width: 100%;
                padding: 15px;
            }

            .logout-btn,
            .change-password-btn {
                padding: 8px 15px;
                font-size: 0.9em;
                margin: 5px;
                float: none;
                display: inline-block;
            }

            /* Modals */
            .modal-content {
                width: 90%;
                margin: 10% auto;
                padding: 20px;
                max-width: none;
                box-sizing: border-box;
            }

            .modal-header {
                font-size: 1.3em;
            }

            .modal-subtitle {
                font-size: 0.9em;
            }

            /* Make modal inputs more compact */
            .modal-content input {
                padding: 10px;
                font-size: 14px;
            }

            .modal-content .btn {
                font-size: 14px;
                padding: 10px 16px;
            }

            /* Collapsible headers */
            .collapsible-header {
                padding: 12px 15px;
            }

            .collapsible-header h2,
            .collapsible-header h3 {
                font-size: 1.1em;
            }

            /* Admin tools */
            #adminToolsPanel .btn {
                width: 100%;
                margin-bottom: 10px;
            }

            #selectedUserInfo {
                padding: 15px;
            }

            #selectedUserInfo > div[style*="grid"] {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            #selectedUserInfo .btn {
                width: 100%;
            }

            /* Table search */
            .table-search input {
                width: 100%;
                padding: 10px;
                font-size: 16px;
            }

            /* Alerts */
            .alert {
                padding: 12px;
                font-size: 0.9em;
            }

            /* Suggestions dropdown */
            .suggestions {
                font-size: 0.9em;
            }

            .suggestion {
                padding: 10px;
            }

            /* Pagination controls - responsive layout */
            #paginationControls {
                flex-direction: column !important;
                gap: 15px !important;
                padding: 10px !important;
            }

            #paginationControls > div {
                width: 100% !important;
                justify-content: center !important;
                flex-wrap: wrap !important;
            }

            #paginationControls select {
                font-size: 14px;
                padding: 6px !important;
            }

            #paginationControls button {
                font-size: 14px !important;
                padding: 6px 12px !important;
                min-height: 36px !important;
                white-space: nowrap;
            }

            #paginationControls span {
                font-size: 14px;
            }

            #paginationControls label {
                font-size: 14px;
            }
        }

        /* Small mobile devices */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.3em;
            }

            /* Single column stats on very small screens */
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-value {
                font-size: 1.5em;
            }

            /* Smaller padding everywhere */
            .data-section {
                padding: 10px;
            }

            .header {
                padding: 15px 10px;
            }

            /* Bar chart even more compact */
            .month-chart {
                height: 200px;
            }

            .bar {
                min-width: 30px;
                margin: 0 2px;
            }

            .bar-label {
                font-size: 0.65em;
            }

            .bar-value {
                font-size: 0.7em;
            }

            /* Modals full screen on very small devices */
            .modal-content {
                width: 100%;
                margin: 5% auto;
                padding: 12px;
                max-height: 90vh;
                overflow-y: auto;
                box-sizing: border-box;
            }

            .modal-header {
                font-size: 1.1em;
                margin-bottom: 8px;
            }

            .modal-subtitle {
                font-size: 0.85em;
                margin-bottom: 15px;
            }

            .modal-content input {
                padding: 8px;
                font-size: 14px;
            }

            .modal-content .form-group {
                margin-bottom: 12px;
            }

            .modal-content .btn {
                font-size: 14px;
                padding: 10px 12px;
            }

            /* Stack button groups vertically */
            div[style*="display: flex; gap: 10px"] button {
                width: 100%;
                margin-bottom: 8px;
            }

            /* Pagination - even more compact on small screens */
            #paginationControls {
                gap: 10px !important;
                padding: 8px !important;
            }

            #paginationControls button {
                font-size: 12px !important;
                padding: 5px 10px !important;
                min-height: 32px !important;
            }

            #paginationControls select {
                font-size: 12px;
                padding: 5px !important;
            }

            #paginationControls span {
                font-size: 12px;
            }

            #paginationControls label {
                font-size: 12px;
            }

            /* Referral section mobile styles */
            #referralsContent input[type="text"] {
                font-size: 14px;
                padding: 8px;
            }

            #referralsContent .btn {
                width: 100%;
                font-size: 14px;
                padding: 10px;
            }

            #generatedLinkContainer {
                flex-direction: column;
            }

            #generatedLinkContainer > div {
                flex-direction: column !important;
            }

            #generatedLinkContainer input {
                min-width: 100% !important;
                margin-bottom: 10px;
            }

            #generatedLinkContainer .btn {
                width: 100%;
            }

            /* Admin referral filter buttons */
            div[style*="display: flex; gap: 10px;"] button[id^="filter"] {
                font-size: 12px;
                padding: 8px 10px;
            }
        }

        /* Landscape orientation tweaks */
        @media (max-width: 768px) and (orientation: landscape) {
            .month-chart {
                height: 180px;
            }

            .modal-content {
                max-height: 85vh;
                overflow-y: auto;
            }
        }

        /* Print styles */
        @media print {
            .logout-btn,
            .change-password-btn,
            .export-btn,
            .collapsible-icon,
            #adminToolsPanel {
                display: none !important;
            }

            .collapsible-content {
                max-height: none !important;
            }

            body {
                background: white;
            }
        }

        /* ========== GAMIFIED REFERRAL REWARDS STYLES ========== */
        .rewards-journey {
            background: #ffffff;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .rewards-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .rewards-title {
            font-size: 1.5em;
            color: #0b1215;
            margin-bottom: 8px;
            padding-bottom: 10px;
            border-bottom: 3px solid #8a2be2;
            display: inline-block;
        }

        .rewards-subtitle {
            color: #666;
            font-size: 0.95em;
            margin-top: 10px;
        }

        .rewards-note {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 12px 15px;
            margin-bottom: 25px;
            font-size: 0.9em;
        }

        .rewards-progress-container {
            margin-bottom: 30px;
        }

        .rewards-progress-track {
            background: #e0e0e0;
            height: 12px;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }

        .rewards-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8a2be2, #a855f7);
            border-radius: 6px;
            transition: width 1s ease-out;
            position: relative;
        }

        .rewards-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .rewards-milestones {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-top: -6px;
            padding: 0 10px;
        }

        .milestone {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .milestone-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #f8f9fa;
            border: 3px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: #999;
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
        }

        .milestone.achieved .milestone-dot {
            background: linear-gradient(135deg, #8a2be2, #a855f7);
            border-color: #8a2be2;
            color: #fff;
            box-shadow: 0 2px 8px rgba(138, 43, 226, 0.4);
        }

        .milestone.current .milestone-dot {
            background: #fff;
            border-color: #8a2be2;
            color: #8a2be2;
            box-shadow: 0 0 0 4px rgba(138, 43, 226, 0.2);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 4px rgba(138, 43, 226, 0.2); }
            50% { box-shadow: 0 0 0 8px rgba(138, 43, 226, 0.1); }
        }

        .milestone-label {
            margin-top: 10px;
            font-size: 0.75em;
            color: #666;
            text-align: center;
            max-width: 70px;
        }

        .milestone.achieved .milestone-label {
            color: #8a2be2;
            font-weight: 600;
        }

        .milestone.current .milestone-label {
            color: #0b1215;
            font-weight: 600;
        }

        .rewards-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .reward-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .reward-card:hover {
            transform: translateY(-3px);
            border-color: #8a2be2;
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.15);
        }

        .reward-card.locked {
            opacity: 0.6;
        }

        .reward-card.unlocked {
            border-color: #4caf50;
            background: #f1f8e9;
        }

        .reward-card.unlocked::before {
            content: 'UNLOCKED';
            position: absolute;
            top: 8px;
            right: -25px;
            background: #4caf50;
            color: #fff;
            font-size: 0.6em;
            font-weight: 700;
            padding: 3px 30px;
            transform: rotate(45deg);
        }

        .reward-title {
            color: #0b1215;
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .reward-requirement {
            color: #666;
            font-size: 0.85em;
        }

        .reward-card.unlocked .reward-requirement {
            color: #4caf50;
            font-weight: 500;
        }

        .reward-card.redeemed {
            opacity: 0.7;
            border-color: #9e9e9e;
            background: #f5f5f5;
        }

        .reward-card.redeemed::before {
            content: 'REDEEMED';
            background: #9e9e9e;
        }

        .redeem-btn {
            margin-top: 12px;
            padding: 8px 20px;
            background: linear-gradient(135deg, #8a2be2, #9c27b0);
            color: #fff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            transition: all 0.3s ease;
            display: none;
        }

        .reward-card.unlocked .redeem-btn {
            display: inline-block;
        }

        .reward-card.redeemed .redeem-btn {
            display: none;
        }

        .redeem-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(138, 43, 226, 0.3);
        }

        .redeem-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .rewards-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid #e0e0e0;
        }

        .reward-stat {
            text-align: center;
        }

        .reward-stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #8a2be2;
            line-height: 1;
        }

        .reward-stat-value.success {
            color: #4caf50;
        }

        .reward-stat-value.pending {
            color: #ff9800;
        }

        .reward-stat-label {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        .cash-option-banner {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 12px 20px;
            margin-top: 20px;
            text-align: center;
        }

        .cash-option-banner span {
            color: #2e7d32;
            font-weight: 500;
        }

        .cash-earned {
            color: #2e7d32;
            font-weight: 700;
            font-size: 1.1em;
        }

        /* Clutch Gems Styling */
        .gem-icon {
            color: #8a2be2;
            font-size: 1.1em;
            margin-right: 2px;
        }

        .gem-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border: 2px solid #8a2be2;
            border-radius: 8px;
            padding: 15px 25px;
            margin-bottom: 20px;
        }

        .gem-display-icon {
            color: #8a2be2;
            font-size: 1.8em;
        }

        .gem-display-text {
            font-size: 1.1em;
            color: #0b1215;
        }

        .gem-display-count {
            font-size: 1.8em;
            font-weight: 700;
            color: #8a2be2;
        }

        .gem-cost {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: #8a2be2;
            font-weight: 600;
        }

        .reward-card .gem-cost {
            margin-top: 8px;
            font-size: 0.9em;
        }

        .milestone-gem {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        /* Mobile responsive for rewards */
        @media (max-width: 768px) {
            .rewards-journey {
                padding: 20px 15px;
            }

            .rewards-title {
                font-size: 1.3em;
            }

            .rewards-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .reward-card {
                padding: 15px 10px;
            }

            .reward-title {
                font-size: 0.9em;
            }

            .reward-requirement {
                font-size: 0.75em;
            }

            .rewards-stats {
                gap: 25px;
            }

            .reward-stat-value {
                font-size: 1.5em;
            }

            .milestone-label {
                font-size: 0.65em;
                max-width: 50px;
            }

            .milestone-dot {
                width: 24px;
                height: 24px;
                font-size: 10px;
            }

            .cash-option-banner {
                padding: 10px 15px;
            }
        }

        @media (max-width: 480px) {
            .rewards-cards {
                grid-template-columns: 1fr 1fr;
            }

            .rewards-stats {
                flex-wrap: wrap;
                gap: 20px;
            }

            .reward-stat {
                flex: 1 1 40%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loadingSection" class="loading">
            <div class="spinner"></div>
            <h3 id="loadingTitle">Loading Dashboard...</h3>
            <p id="loadingMessage" style="color: #666;">Fetching data from server</p>
        </div>
        
        <div id="errorSection" class="error" style="display: none;">
            <h3>Error Loading Data</h3>
            <p id="errorMessage"></p>
            <button class="btn" onclick="location.reload()" style="max-width: 200px; margin: 20px auto;">Reload Page</button>
        </div>

        <div id="loginSection" style="display: none;">
            <div class="login-form">
                <h2 style="margin-bottom: 30px; text-align: center; color: #0b1215;">ICON Royalty Portal</h2>

                <!-- Login Type Toggle -->
                <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                    <button id="athleteLoginBtn" class="btn" onclick="switchLoginType('athlete')" style="flex: 1; background: linear-gradient(135deg, #8a2be2 0%, #0b1215 100%);">
                        Athlete Login
                    </button>
                    <button id="orgLoginBtn" class="btn" onclick="switchLoginType('organization')" style="flex: 1; background: #6c757d;">
                        Organization Login
                    </button>
                </div>

                <!-- Athlete Login Form -->
                <div id="athleteLoginForm">
                    <div class="form-group">
                        <label for="athleteSearch">Enter Your Name</label>
                        <div class="search-container">
                            <input
                                type="text"
                                id="athleteSearch"
                                placeholder="Start typing your name..."
                                autocomplete="off"
                            >
                            <div id="suggestions" class="suggestions"></div>
                        </div>
                        <div class="search-hint">Type at least 2 letters to see suggestions</div>
                    </div>

                    <div class="form-group">
                        <label for="accessCode">Access Code</label>
                        <input type="text" id="accessCode" placeholder="Enter your code">
                    </div>

                    <button id="loginBtn" class="btn" onclick="login()" disabled>Login to Dashboard</button>
                </div>

                <!-- Organization Login Form -->
                <div id="organizationLoginForm" style="display: none;">
                    <div class="form-group">
                        <label for="orgSelect">Select Organization</label>
                        <select id="orgSelect" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; font-size: 1em;">
                            <option value="">-- Select Organization --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="orgPassword">Organization Password</label>
                        <input type="password" id="orgPassword" placeholder="Enter organization password">
                    </div>

                    <button id="orgLoginSubmitBtn" class="btn" onclick="loginAsOrganization()">Login as Organization</button>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; text-align: center;">
                    <small style="color: #666;">Need your access code? DM us on instagram!</small>
                </div>
            </div>
        </div>
        
        <div id="dashboard" class="dashboard">
            <div class="header">
                <button class="change-password-btn" onclick="openPasswordModal()">Change Password</button>
                <button class="logout-btn" onclick="logout()">Logout</button>
                <h1>Welcome, <span id="athleteName"></span>!</h1>
                <p class="subtitle">Your Royalty Dashboard</p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalRoyalties">$0</div>
                    <div class="stat-label">Total Royalties</div>
                </div>

                <div class="stat-card">
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-label">Total Items</div>
                </div>

                <div class="stat-card">
                    <div class="stat-value" id="gameJerseys">0</div>
                    <div class="stat-label">Game Jerseys</div>
                </div>

                <div class="stat-card">
                    <div class="stat-value" id="otherItems">0</div>
                    <div class="stat-label">Other Items</div>
                </div>
            </div>

            <div id="jersey20Alert" class="alert" style="display: none;">
                <strong>Note:</strong> <span id="jersey20Count"></span> items had JERSEY20 discount applied (no royalty on those orders).
            </div>

            <div class="alert" style="background: #e3f2fd; border-color: #2196f3; color: #0d47a1;">
                <strong>Royalty Structure:</strong> Game Jerseys = $10 | All Other Items = $5
            </div>

            <div class="data-section">
                <h2 class="section-title">Monthly Breakdown</h2>
                <div class="month-chart" id="monthChart"></div>
            </div>

            <div class="data-section">
                <div class="collapsible-header" onclick="toggleOrderHistory()">
                    <h2 style="margin: 0;">Order History</h2>
                    <span class="collapsible-icon open" id="orderHistoryIcon">â–¼</span>
                </div>

                <div class="collapsible-content open" id="orderHistoryContent">
                    <div class="table-search">
                        <input
                            type="text"
                            id="tableSearch"
                            placeholder="Search orders..."
                            onkeyup="filterTable()"
                        >
                    </div>

                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order #</th>
                                    <th>Product</th>
                                    <th>Date</th>
                                    <th>Payout by</th>
                                    <th>Discount</th>
                                    <th>Royalty</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTable">
                                <tr><td colspan="6">No data loaded</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination Controls -->
                    <div id="paginationControls" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="font-weight: 600;">Show:</label>
                            <select id="pageSize" onchange="changePageSize()" style="padding: 8px; border: 2px solid #e0e0e0; border-radius: 4px;">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="all">All</option>
                            </select>
                            <span style="color: #666;">entries</span>
                        </div>

                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button onclick="previousPage()" id="prevPageBtn" class="btn" style="padding: 8px 16px; width: auto; background: #6c757d;">Previous</button>
                            <span id="pageInfo" style="font-weight: 600; color: #0b1215;">Page 1 of 1</span>
                            <button onclick="nextPage()" id="nextPageBtn" class="btn" style="padding: 8px 16px; width: auto; background: #6c757d;">Next</button>
                        </div>

                        <div style="color: #666;">
                            Showing <span id="showingRange">0-0</span> of <span id="totalEntries">0</span>
                        </div>
                    </div>

                    <button class="export-btn" onclick="exportData()">Export My Data</button>
                </div>
            </div>

            <!-- Referral Rewards Journey Section -->
            <div id="rewardsJourneyPanel" style="display: none;">
                <div class="rewards-journey">
                    <div class="rewards-header">
                        <h2 class="rewards-title">Referral Rewards</h2>
                        <p class="rewards-subtitle">Earn 1 gem for each successful referral, then spend them on rewards!</p>
                    </div>

                    <!-- Gem Balance Display -->
                    <div class="gem-display">
                        <span class="gem-display-icon">&#9670;</span>
                        <span class="gem-display-count" id="clutchGemsCount">0</span>
                    </div>

                    <!-- Progress Bar with Milestones -->
                    <div class="rewards-progress-container">
                        <div class="rewards-progress-track">
                            <div class="rewards-progress-fill" id="rewardsProgressFill" style="width: 0%;"></div>
                        </div>
                        <div class="rewards-milestones">
                            <div class="milestone" id="milestone0">
                                <div class="milestone-dot">0</div>
                                <span class="milestone-label">Start</span>
                            </div>
                            <div class="milestone" id="milestone2">
                                <div class="milestone-dot">2</div>
                                <span class="milestone-label">Shirt</span>
                            </div>
                            <div class="milestone" id="milestone3">
                                <div class="milestone-dot">3</div>
                                <span class="milestone-label">Any Item</span>
                            </div>
                            <div class="milestone" id="milestone5">
                                <div class="milestone-dot">5</div>
                                <span class="milestone-label">Hoodie or Jersey</span>
                            </div>
                        </div>
                    </div>

                    <!-- Reward Cards -->
                    <div class="rewards-cards">
                        <div class="reward-card locked" id="rewardCard2">
                            <div class="reward-title">Shirt</div>
                            <div class="reward-requirement">Redeem for a free shirt</div>
                            <div class="gem-cost"><span class="gem-icon">&#9670;</span> 2 Gems</div>
                            <button class="redeem-btn" onclick="redeemReward('shirt', 2)">Redeem</button>
                        </div>
                        <div class="reward-card locked" id="rewardCard3">
                            <div class="reward-title">Any Item</div>
                            <div class="reward-requirement">Excluding hoodie or jersey</div>
                            <div class="gem-cost"><span class="gem-icon">&#9670;</span> 3 Gems</div>
                            <button class="redeem-btn" onclick="redeemReward('any_item', 3)">Redeem</button>
                        </div>
                        <div class="reward-card locked" id="rewardCard5">
                            <div class="reward-title">Hoodie or Jersey</div>
                            <div class="reward-requirement">Your choice of either</div>
                            <div class="gem-cost"><span class="gem-icon">&#9670;</span> 5 Gems</div>
                            <button class="redeem-btn" onclick="redeemReward('hoodie_or_jersey', 5)">Redeem</button>
                        </div>
                    </div>

                    <!-- Cash Option Banner -->
                    <div class="cash-option-banner">
                        <span>OR redeem <strong>$5 cash</strong> per gem!</span>
                        <span id="cashEarnedDisplay" class="cash-earned" style="display: none;"></span>
                    </div>

                    <!-- Stats Summary -->
                    <div class="rewards-stats">
                        <div class="reward-stat">
                            <div class="reward-stat-value" id="totalReferralsCount">0</div>
                            <div class="reward-stat-label">Total Referrals</div>
                        </div>
                        <div class="reward-stat">
                            <div class="reward-stat-value success" id="successfulReferralsCount">0</div>
                            <div class="reward-stat-label">Successful</div>
                        </div>
                        <div class="reward-stat">
                            <div class="reward-stat-value pending" id="pendingReferralsCount">0</div>
                            <div class="reward-stat-label">Pending</div>
                        </div>
                    </div>

                    <!-- Referrals Section (merged) -->
                    <div id="referralsContent" style="margin-top: 30px; padding-top: 25px; border-top: 1px solid #e0e0e0;">
                        <p style="color: #666; margin-bottom: 20px;">
                            Refer friends to join ICON Royalty! Share your unique referral link and earn rewards when they sign up.
                        </p>

                        <!-- Generate Referral Link Form -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; margin-bottom: 15px;">Generate Referral Link</h3>
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <div>
                                    <label for="referralName" style="display: block; margin-bottom: 5px; font-weight: 500;">Friend's Name:</label>
                                    <input type="text" id="referralName" placeholder="Enter their name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                                </div>
                                <div>
                                    <label for="referralInstagram" style="display: block; margin-bottom: 5px; font-weight: 500;">Friend's Instagram (optional):</label>
                                    <input type="text" id="referralInstagram" placeholder="@username" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                                </div>
                                <button class="btn" onclick="generateReferralLink()" style="align-self: flex-start;">Generate Referral Link</button>
                            </div>

                            <!-- Generated Link Display -->
                            <div id="generatedLinkContainer" style="display: none; margin-top: 20px; padding: 15px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">
                                <p style="margin: 0 0 10px 0; font-weight: 500; color: #2e7d32;">âœ“ Referral link generated!</p>
                                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                    <input type="text" id="generatedLink" readonly style="flex: 1; min-width: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
                                    <button class="btn" onclick="copyReferralLink()">Copy Link</button>
                                </div>
                                <p id="copyFeedback" style="margin: 10px 0 0 0; color: #2e7d32; font-size: 14px; display: none;">âœ“ Link copied to clipboard!</p>
                            </div>
                        </div>

                        <!-- Referrals List -->
                        <div style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Friend's Name</th>
                                        <th>Instagram</th>
                                        <th>Date Referred</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="referralsTableBody">
                                    <tr>
                                        <td colspan="4" style="text-align: center; color: #999;">No referrals yet</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tagged Athletes Section (Only visible for organization logins) -->
            <div id="taggedAthletesPanel" style="display: none;">
                <div class="data-section">
                    <div class="collapsible-header" onclick="toggleTaggedAthletes()">
                        <h2 style="margin: 0;">Your Athletes (<span id="taggedAthletesCount">0</span>)</h2>
                        <span class="collapsible-icon open" id="taggedAthletesIcon">â–¼</span>
                    </div>

                    <div class="collapsible-content open" id="taggedAthletesContent">
                        <p style="color: #666; margin-bottom: 20px;">
                            These athletes are tagged with your organization. View their sales performance and notes below.
                        </p>

                        <div style="overflow-x: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Athlete Name</th>
                                        <th>Total Sales</th>
                                        <th>Total Royalties</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="taggedAthletesTable">
                                    <tr><td colspan="4" style="text-align: center; color: #666;">No athletes tagged with this organization</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Tools Panel (Only visible for admins) -->
            <div id="adminToolsPanel" style="display: none;">
                <div class="data-section">
                    <div class="collapsible-header" onclick="toggleAdminTools()">
                        <h2 style="margin: 0;">Admin Tools</h2>
                        <span class="collapsible-icon" id="adminToolsIcon">â–¼</span>
                    </div>

                    <div class="collapsible-content" id="adminToolsContent">
                        <!-- User Management Section -->
                        <div style="margin-top: 20px;">
                            <h3 style="margin-bottom: 15px;">User Management</h3>

                    <!-- User Search -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="adminUserSearch">Search User</label>
                        <div class="search-container">
                            <input type="text"
                                   id="adminUserSearch"
                                   placeholder="Type to search athletes..."
                                   oninput="filterAdminUsers()"
                                   style="width: 100%;">
                            <div id="adminUserList" class="suggestions"></div>
                        </div>
                    </div>

                    <!-- Selected User Info -->
                    <div id="selectedUserInfo" style="display: none; padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px;">Selected User: <span id="selectedUserName" style="color: #8a2be2;"></span></h4>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <strong>Default Password:</strong> <span id="selectedUserDefaultPwd"></span>
                            </div>
                            <div>
                                <strong>Has Custom Password:</strong> <span id="selectedUserHasCustomPwd"></span>
                            </div>
                        </div>

                        <!-- Admin Notes Section -->
                        <div style="margin-bottom: 15px; padding: 15px; background: #fff; border-radius: 8px; border: 2px solid #e0e0e0;">
                            <h4 style="margin: 0 0 10px 0; color: #8a2be2; font-size: 0.95em;">Admin Notes</h4>
                            <textarea id="athleteNotesTextarea"
                                      placeholder="Add private notes about this athlete (visible to admin and their organization)..."
                                      style="width: 100%; min-height: 100px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 4px; font-family: inherit; font-size: 0.9em; resize: vertical;"></textarea>
                            <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
                                <button class="btn" onclick="saveAthleteNotes()" style="background: #8a2be2; padding: 8px 20px; font-size: 0.9em;">
                                    Save Notes
                                </button>
                                <span id="notesSaveStatus" style="font-size: 0.9em; font-weight: 600;"></span>
                            </div>
                            <small style="color: #666; display: block; margin-top: 8px;">
                                <strong>Note:</strong> These notes are visible to the admin and the athlete's organization (if assigned).
                            </small>
                        </div>

                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn" onclick="resetUserPassword()" style="background: #dc3545;">
                                Reset to Default Password
                            </button>
                            <button class="btn" onclick="setCustomPasswordForUser()" style="background: #28a745;">
                                Set Custom Password
                            </button>
                            <button class="btn" onclick="viewUserData()" style="background: #17a2b8;">
                                View User's Data
                            </button>
                        </div>
                    </div>

                    <!-- All Users List -->
                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px;">All Users Status</h3>
                        <div style="margin-bottom: 10px;">
                            <label>
                                <input type="checkbox" id="showOnlyCustomPwdUsers" onchange="refreshUserStatusTable()">
                                Show only users with custom passwords
                            </label>
                        </div>
                        <div id="allUsersTable" style="max-height: 400px; overflow-y: auto;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Athlete Name</th>
                                        <th>Default Password</th>
                                        <th>Custom Password Set</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="allUsersTableBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                        <!-- Organization Management Section -->
                        <div style="margin-top: 40px; border-top: 3px solid #e0e0e0; padding-top: 30px;">
                            <h3 style="margin-bottom: 20px;">Organization Management</h3>

                            <!-- Create New Organization -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="margin-bottom: 15px;">Create New Organization</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Organization Name</label>
                                        <input type="text" id="newOrgName" placeholder="e.g., NIL CLUB" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0;">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Password</label>
                                        <input type="password" id="newOrgPassword" placeholder="Organization password" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0;">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Signup Bonus Per Athlete ($)</label>
                                        <input type="number" id="newOrgReferralPerSale" placeholder="e.g., 5" step="0.01" min="0" value="0" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0;">
                                        <small style="color: #666; display: block; margin-top: 5px;">One-time payment per athlete signed up</small>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Bonus Percentage (%)</label>
                                        <input type="number" id="newOrgBonusPercentage" placeholder="e.g., 20" step="0.1" min="0" max="100" value="0" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0;">
                                        <small style="color: #666; display: block; margin-top: 5px;">% bonus on all athlete sales</small>
                                    </div>
                                </div>
                                <button class="btn" onclick="createOrganization()" style="width: auto; padding: 10px 30px;">
                                    Create Organization
                                </button>
                            </div>

                            <!-- Existing Organizations List -->
                            <div>
                                <h4 style="margin-bottom: 15px;">Existing Organizations</h4>
                                <div id="organizationsList" style="max-height: 300px; overflow-y: auto;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Organization Name</th>
                                                <th>Signup Bonus</th>
                                                <th>Bonus %</th>
                                                <th>Tagged Athletes</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="organizationsTableBody">
                                            <tr><td colspan="5" style="text-align: center;">Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Manual Athlete Entry Section -->
                        <div style="margin-top: 40px; border-top: 3px solid #e0e0e0; padding-top: 30px;">
                            <h3 style="margin-bottom: 20px;">Manual Athlete Entry</h3>

                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="margin-bottom: 15px;">Add New Athlete</h4>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Athlete Name <span style="color: red;">*</span></label>
                                        <input type="text" id="newAthleteName" placeholder="e.g., John Smith" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0;">
                                        <small style="color: #666; display: block; margin-top: 5px;">Full name of the athlete</small>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email</label>
                                        <input type="email" id="newAthleteEmail" placeholder="athlete@example.com" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0;">
                                        <small style="color: #666; display: block; margin-top: 5px;">Optional email address</small>
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Access Code</label>
                                        <input type="text" id="newAthleteAccessCode" placeholder="Auto-generated if left blank" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0;">
                                        <small style="color: #666; display: block; margin-top: 5px;">Leave blank to auto-generate (e.g., JS2025)</small>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Initial Password</label>
                                        <input type="text" id="newAthletePassword" placeholder="Auto-generated if left blank" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0;">
                                        <small style="color: #666; display: block; margin-top: 5px;">Leave blank for default (initials + 2025)</small>
                                    </div>
                                </div>

                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Organization (Optional)</label>
                                    <select id="newAthleteOrganization" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0;">
                                        <option value="">-- No Organization --</option>
                                    </select>
                                    <small style="color: #666; display: block; margin-top: 5px;">Assign athlete to an organization</small>
                                </div>

                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <button class="btn" onclick="createManualAthlete()" style="background: #8a2be2; width: auto; padding: 10px 30px;">
                                        Add Athlete
                                    </button>
                                    <button class="btn" onclick="clearAthleteForm()" style="background: #6c757d; width: auto; padding: 10px 30px;">
                                        Clear Form
                                    </button>
                                    <span id="athleteCreationStatus" style="margin-left: 10px; font-weight: 600;"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Athlete Organization Tagging Section -->
                        <div style="margin-top: 40px; border-top: 3px solid #e0e0e0; padding-top: 30px;">
                            <h3 style="margin-bottom: 20px;">Athlete Organization Tagging</h3>

                            <div class="form-group" style="margin-bottom: 20px;">
                                <label for="athleteTagSearch">Select Athlete</label>
                                <div class="search-container">
                                    <input type="text"
                                           id="athleteTagSearch"
                                           placeholder="Type to search athletes..."
                                           oninput="filterAthleteTagList()"
                                           style="width: 100%;">
                                    <div id="athleteTagList" class="suggestions"></div>
                                </div>
                            </div>

                            <div id="athleteTagInfo" style="display: none; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                                <h4 style="margin-bottom: 15px;">Athlete: <span id="selectedAthleteName" style="color: #8a2be2;"></span></h4>

                                <div style="margin-bottom: 15px;">
                                    <strong>Current Organization:</strong>
                                    <span id="currentOrgTag" style="color: #28a745; font-weight: 600;">None</span>
                                </div>

                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Assign Organization</label>
                                    <select id="orgTagSelect" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0;">
                                        <option value="">-- No Organization --</option>
                                    </select>
                                </div>

                                <div style="display: flex; gap: 10px;">
                                    <button class="btn" onclick="updateAthleteOrganization()" style="background: #28a745; width: auto; padding: 10px 30px;">
                                        Update Organization
                                    </button>
                                    <button class="btn" onclick="removeAthleteOrganization()" style="background: #dc3545; width: auto; padding: 10px 30px;">
                                        Remove Organization
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Referral Management Section -->
                        <div style="margin-top: 40px; border-top: 3px solid #e0e0e0; padding-top: 30px;">
                            <h3 style="margin-bottom: 20px;">Referral Management</h3>

                            <!-- All Referrals List -->
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                                    <h4 style="margin: 0;">All Referrals</h4>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn" onclick="filterReferrals('all')" id="filterAllReferrals" style="padding: 8px 16px; background: #8a2be2; font-size: 0.9em;">
                                            All
                                        </button>
                                        <button class="btn" onclick="filterReferrals('pending')" id="filterPendingReferrals" style="padding: 8px 16px; background: #6c757d; font-size: 0.9em;">
                                            Pending
                                        </button>
                                        <button class="btn" onclick="filterReferrals('success')" id="filterSuccessReferrals" style="padding: 8px 16px; background: #6c757d; font-size: 0.9em;">
                                            Success
                                        </button>
                                    </div>
                                </div>

                                <div style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Referrer</th>
                                                <th>Referee Name</th>
                                                <th>Instagram</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adminReferralsTable">
                                            <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Manual Referral Status Update -->
                            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border: 2px solid #ffc107;">
                                <h4 style="margin-bottom: 15px; color: #856404;">Manual Status Update</h4>
                                <p style="color: #856404; margin-bottom: 15px;">Use this section to manually mark referrals as successful. This will update the status and trigger the success notification.</p>

                                <div class="form-group">
                                    <label for="referralSearchInput">Search Referral by Referee Name or Instagram</label>
                                    <input type="text" id="referralSearchInput" placeholder="Type to search referrals..." style="width: 100%;">
                                </div>

                                <div id="selectedReferralInfo" style="display: none; padding: 15px; background: white; border-radius: 8px; margin-top: 15px;">
                                    <p><strong>Referrer:</strong> <span id="selectedReferralReferrer"></span></p>
                                    <p><strong>Referee:</strong> <span id="selectedReferralReferee"></span></p>
                                    <p><strong>Current Status:</strong> <span id="selectedReferralStatus"></span></p>

                                    <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                                        <button class="btn" onclick="markReferralAsSuccess()" style="background: #28a745; padding: 10px 20px;">
                                            Mark as Success
                                        </button>
                                        <button class="btn" onclick="markReferralAsPending()" style="background: #ffc107; padding: 10px 20px; color: #000;">
                                            Mark as Pending
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Database Cleanup Section -->
                        <div style="margin-top: 40px; border-top: 3px solid #e0e0e0; padding-top: 30px;">
                            <h3 style="margin-bottom: 20px;">âš™ï¸ Database Maintenance</h3>

                            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <h4 style="margin-top: 0; color: #856404;">Fix Duplicate Athlete Entries</h4>
                                <p style="color: #856404; margin-bottom: 15px;">
                                    If athletes were added via Zapier using push() instead of set(), they may have duplicate entries with random IDs (like -OecXb5yQCrzTrU7VzFS).
                                    This tool will consolidate duplicates by moving referrals and data to the correct sanitized name entries.
                                </p>

                                <div id="cleanupStatus" style="padding: 10px; background: white; border-radius: 4px; margin-bottom: 15px; display: none;">
                                    <p id="cleanupStatusMessage" style="margin: 0;"></p>
                                </div>

                                <button class="btn" onclick="scanForDuplicateAthletes()" style="background: #007bff; margin-right: 10px;">
                                    Scan for Duplicates
                                </button>

                                <button class="btn" onclick="consolidateDuplicateAthletes()" style="background: #28a745; display: none;" id="consolidateBtn">
                                    Consolidate Duplicates
                                </button>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Password Change Modal -->
        <div id="passwordModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closePasswordModal()">&times;</span>
                <h2 class="modal-header">Change Password</h2>
                <p class="modal-subtitle">Create a new password for your account</p>

                <div class="form-group">
                    <label for="currentPassword">Current Password</label>
                    <input type="password" id="currentPassword" placeholder="Enter current password">
                </div>

                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" placeholder="Enter new password" oninput="checkPasswordStrength()">
                    <div id="passwordStrength" class="password-strength"></div>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm new password">
                </div>

                <button class="btn" onclick="changePassword()" style="margin-top: 20px;">Update Password</button>
            </div>
        </div>

        <!-- First Login Modal -->
        <div id="firstLoginModal" class="modal">
            <div class="modal-content">
                <h2 class="modal-header">Welcome!</h2>
                <p class="modal-subtitle">For security, please change your default password</p>

                <div class="form-group">
                    <label for="firstLoginNewPassword">New Password</label>
                    <input type="password" id="firstLoginNewPassword" placeholder="Enter new password" oninput="checkFirstLoginPasswordStrength()">
                    <div id="firstLoginPasswordStrength" class="password-strength"></div>
                </div>

                <div class="form-group">
                    <label for="firstLoginConfirmPassword">Confirm New Password</label>
                    <input type="password" id="firstLoginConfirmPassword" placeholder="Confirm new password">
                </div>

                <button class="btn" onclick="setFirstPassword()" style="margin-top: 20px;">Set Password</button>
                <button class="btn" onclick="skipPasswordChange()" style="margin-top: 10px; background: #6c757d;">Skip for Now</button>
            </div>
        </div>
    </div>

    <!-- Admin: Set Custom Password Modal -->
    <div id="adminSetPasswordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAdminSetPasswordModal()">&times;</span>
            <h2 class="modal-header">Set Custom Password for User</h2>
            <p class="modal-subtitle">Set a new password for <strong><span id="adminPwdUserName"></span></strong></p>

            <div class="form-group">
                <label for="adminNewPassword">New Password</label>
                <input type="password" id="adminNewPassword" placeholder="Enter new password">
            </div>

            <div class="form-group">
                <label for="adminConfirmPassword">Confirm Password</label>
                <input type="password" id="adminConfirmPassword" placeholder="Confirm password">
            </div>

            <button class="btn" onclick="confirmSetCustomPassword()">Set Password</button>
        </div>
    </div>

    <!-- Admin: View User Data Modal -->
    <div id="adminViewDataModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeAdminViewDataModal()">&times;</span>
            <h2 class="modal-header">User Data: <span id="viewDataUserName"></span></h2>

            <div style="margin: 20px 0;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: #666;">Total Royalties</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #8a2be2;" id="viewDataTotalRoyalties">$0</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: #666;">Total Orders</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #8a2be2;" id="viewDataTotalOrders">0</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 0.9em; color: #666;">Total Units</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #8a2be2;" id="viewDataTotalUnits">0</div>
                    </div>
                </div>

                <div id="viewDataTableContainer" style="max-height: 400px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Order</th>
                                <th>Date</th>
                                <th>Payout by</th>
                                <th>Product</th>
                                <th>Royalty</th>
                            </tr>
                        </thead>
                        <tbody id="viewDataTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Organization: Edit Modal -->
    <div id="editOrganizationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditOrganizationModal()">&times;</span>
            <h2 class="modal-header">Edit Organization</h2>
            <p class="modal-subtitle">Update organization details</p>

            <input type="hidden" id="editOrgId">

            <div class="form-group">
                <label for="editOrgName">Organization Name</label>
                <input type="text" id="editOrgName" placeholder="Organization name">
            </div>

            <div class="form-group">
                <label for="editOrgPassword">New Password (leave blank to keep current)</label>
                <input type="password" id="editOrgPassword" placeholder="New password">
            </div>

            <div class="form-group">
                <label for="editOrgReferralPerSale">Signup Bonus Per Athlete ($)</label>
                <input type="number" id="editOrgReferralPerSale" placeholder="e.g., 5" step="0.01" min="0">
                <small style="color: #666; display: block; margin-top: 5px;">One-time payment per athlete signed up</small>
            </div>

            <div class="form-group">
                <label for="editOrgBonusPercentage">Bonus Percentage (%)</label>
                <input type="number" id="editOrgBonusPercentage" placeholder="e.g., 20" step="0.1" min="0" max="100">
                <small style="color: #666; display: block; margin-top: 5px;">% bonus on all athlete sales</small>
            </div>

            <button class="btn" onclick="confirmEditOrganization()">Update Organization</button>
        </div>
    </div>

    <!-- Organization: View Athletes Modal -->
    <div id="viewOrgAthletesModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeViewOrgAthletesModal()">&times;</span>
            <h2 class="modal-header">Organization Athletes: <span id="viewOrgAthletesName"></span></h2>

            <div id="viewOrgAthletesContainer" style="max-height: 400px; overflow-y: auto; margin-top: 20px;">
                <table>
                    <thead>
                        <tr>
                            <th>Athlete Name</th>
                            <th>Total Sales</th>
                            <th>Total Royalties</th>
                            <th style="min-width: 200px;">Admin Notes</th>
                        </tr>
                    </thead>
                    <tbody id="viewOrgAthletesTableBody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        /**
         * FIREBASE AUTHENTICATION IMPLEMENTATION
         *
         * This portal uses Firebase Authentication with synthetic emails to maintain
         * the existing Name + Access Code UX while gaining proper authentication security.
         *
         * How it works:
         * - User enters: "John Doe" + password
         * - Backend converts to: "john_doe@iconportal.internal" + password
         * - Firebase Auth handles: encryption, sessions, token management
         * - User never sees the synthetic email
         *
         * Lazy Migration:
         * - First login: Creates Firebase Auth account automatically
         * - Subsequent logins: Uses Firebase Auth
         * - No bulk migration needed
         * - No real emails required
         *
         * Roles:
         * - admin: Full access to all data and admin tools
         * - athlete: Access to own sales data and referrals
         * - organization: Access to tagged athletes' data
         *
         * Future: Can add real emails and password reset functionality later
         */

        let allData = [];
        let athleteData = {};
        let accessCodes = {};
        let currentAthlete = '';
        let selectedSuggestionIndex = -1;
        let athletesList = [];
        let usedDefaultPassword = false;

        // Store access code and org name for referral system
        window.currentAccessCode = null;
        window.currentOrgName = null;

        // Admin functionality variables
        let selectedAdminUser = null;
        let allCustomPasswords = {};

        // Organization functionality variables
        let allOrganizations = {};
        let athleteOrganizations = {};
        let selectedAthleteForTag = null;
        let currentOrganization = null;
        let currentLoginType = 'athlete';

        // Athlete notes (admin only, visible to organizations)
        let athleteNotes = {};

        // Pagination variables
        let currentPage = 1;
        let pageSize = 25;
        let filteredTableData = [];

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDNgeKx-tU9elTEn4GfJVIf2SdIAs46USg",
            authDomain: "icon-royalty-portal.firebaseapp.com",
            databaseURL: "https://icon-royalty-portal-default-rtdb.firebaseio.com",
            projectId: "icon-royalty-portal",
            storageBucket: "icon-royalty-portal.firebasestorage.app",
            messagingSenderId: "493137013703",
            appId: "1:493137013703:web:0db4615d66baa1872347e2"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // Set auth persistence to LOCAL (persist across browser sessions/refreshes)
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
                console.log('âœ… Auth persistence set to LOCAL');
            })
            .catch((error) => {
                console.error('Error setting auth persistence:', error);
            });

        // Current user state
        let currentUser = null;
        let currentRole = null;

        // Helper: Sanitize Firebase keys (remove invalid characters)
        function sanitizeFirebaseKey(key) {
            // Firebase doesn't allow: . # $ / [ ]
            // Also replace spaces with underscores for consistency
            return key.replace(/[.#$\/\[\]\s]/g, '_');
        }

        // Helper: Convert name to synthetic email for Firebase Auth
        function nameToEmail(athleteName) {
            // Convert "Marlon Seahorn Jr" â†’ "marlon_seahorn_jr@iconportal.internal"
            return athleteName
                .toLowerCase()
                .replace(/[^a-z0-9]/g, '_')
                .replace(/_+/g, '_')
                .replace(/^_|_$/g, '') + '@iconportal.internal';
        }

        // Helper: Check if Firebase Auth account exists for this name
        async function emailExistsForName(athleteName) {
            const email = nameToEmail(athleteName);
            try {
                const methods = await auth.fetchSignInMethodsForEmail(email);
                return methods && methods.length > 0;
            } catch (error) {
                console.error('Error checking email existence:', error);
                return false;
            }
        }

        // Helper: Set user role in database (custom claims would require Cloud Functions)
        async function setUserRoleInDatabase(uid, role, athleteName, organizationId = null) {
            try {
                await database.ref(`userRoles/${uid}`).set({
                    role: role,
                    athleteName: athleteName || null,
                    organizationId: organizationId || null,
                    createdAt: new Date().toISOString()
                });

                // Also update the athlete/organization record with the uid
                if (athleteName && role === 'athlete') {
                    await database.ref(`athletes/${sanitizeFirebaseKey(athleteName)}/uid`).set(uid);
                } else if (organizationId && role === 'organization') {
                    await database.ref(`organizations/${organizationId}/uid`).set(uid);
                }

                console.log('User role set in database:', { uid, role, athleteName, organizationId });
            } catch (error) {
                console.error('Error setting user role:', error);
                throw error;
            }
        }

        // Helper: Get user role from database
        async function getUserRole(uid) {
            try {
                const snapshot = await database.ref(`userRoles/${uid}`).once('value');
                return snapshot.val();
            } catch (error) {
                console.error('Error getting user role:', error);
                return null;
            }
        }

        // Password Management Functions (Firebase)
        async function getStoredPassword(athleteName) {
            try {
                // Special handling for admin - password stored under "Admin" key
                let lookupName = athleteName;
                if (athleteName === 'Admin (View All)' || athleteName === 'Admin' || athleteName === 'ALL') {
                    lookupName = 'Admin';
                }

                const sanitizedName = sanitizeFirebaseKey(lookupName);
                const snapshot = await database.ref('customPasswords/' + sanitizedName).once('value');
                return snapshot.val();
            } catch (error) {
                console.error('Error getting password:', error);
                return null;
            }
        }

        async function setStoredPassword(athleteName, password) {
            try {
                // Special handling for admin - store password under "Admin" key
                let lookupName = athleteName;
                if (athleteName === 'Admin (View All)' || athleteName === 'Admin' || athleteName === 'ALL') {
                    lookupName = 'Admin';
                }

                const sanitizedName = sanitizeFirebaseKey(lookupName);
                await database.ref('customPasswords/' + sanitizedName).set(password);
                console.log('Password saved to Firebase for:', athleteName);
            } catch (error) {
                console.error('Error saving password:', error);
                throw error;
            }
        }

        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthDiv = document.getElementById('passwordStrength');

            if (password.length === 0) {
                strengthDiv.textContent = '';
                return;
            }

            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;

            if (strength < 3) {
                strengthDiv.textContent = 'Weak password';
                strengthDiv.className = 'password-strength strength-weak';
            } else if (strength < 5) {
                strengthDiv.textContent = 'Medium password';
                strengthDiv.className = 'password-strength strength-medium';
            } else {
                strengthDiv.textContent = 'Strong password';
                strengthDiv.className = 'password-strength strength-strong';
            }
        }

        function checkFirstLoginPasswordStrength() {
            const password = document.getElementById('firstLoginNewPassword').value;
            const strengthDiv = document.getElementById('firstLoginPasswordStrength');

            if (password.length === 0) {
                strengthDiv.textContent = '';
                return;
            }

            let strength = 0;
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;

            if (strength < 3) {
                strengthDiv.textContent = 'Weak password';
                strengthDiv.className = 'password-strength strength-weak';
            } else if (strength < 5) {
                strengthDiv.textContent = 'Medium password';
                strengthDiv.className = 'password-strength strength-medium';
            } else {
                strengthDiv.textContent = 'Strong password';
                strengthDiv.className = 'password-strength strength-strong';
            }
        }

        function openPasswordModal() {
            document.getElementById('passwordModal').style.display = 'block';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordStrength').textContent = '';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        function openFirstLoginModal() {
            document.getElementById('firstLoginModal').style.display = 'block';
            document.getElementById('firstLoginNewPassword').value = '';
            document.getElementById('firstLoginConfirmPassword').value = '';
            document.getElementById('firstLoginPasswordStrength').textContent = '';
        }

        function closeFirstLoginModal() {
            document.getElementById('firstLoginModal').style.display = 'none';
        }

        function skipPasswordChange() {
            closeFirstLoginModal();
        }

        async function setFirstPassword() {
            const newPassword = document.getElementById('firstLoginNewPassword').value;
            const confirmPassword = document.getElementById('firstLoginConfirmPassword').value;

            if (!newPassword || !confirmPassword) {
                alert('Please fill in all fields');
                return;
            }

            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            try {
                // Update Firebase Auth password
                if (currentUser) {
                    await currentUser.updatePassword(newPassword);
                    console.log('âœ… Password updated in Firebase Auth');
                }

                // Also update in database for backward compatibility (optional, may fail due to permissions)
                try {
                    await setStoredPassword(currentAthlete, newPassword);
                    console.log('âœ… Password also saved to database');
                } catch (dbError) {
                    console.warn('Could not save password to database (non-critical):', dbError);
                    // This is not critical - the Firebase Auth password is what matters for login
                }

                alert('Password changed successfully!');
                closeFirstLoginModal();
            } catch (error) {
                console.error('Error changing password:', error);
                if (error.code === 'auth/requires-recent-login') {
                    alert('For security, please log out and log back in before changing your password.');
                } else {
                    alert('Failed to change password. Please try again.');
                }
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Please fill in all fields');
                return;
            }

            if (newPassword.length < 6) {
                alert('New password must be at least 6 characters long');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }

            const initialsPassword = generatePasswordFromName(currentAthlete);
            if (initialsPassword && newPassword.toUpperCase() === initialsPassword) {
                alert('New password cannot be the default password');
                return;
            }

            try {
                // Re-authenticate user with Firebase Auth (required before password change)
                if (currentUser) {
                    const syntheticEmail = nameToEmail(currentAthlete === 'ALL' ? 'Admin (View All)' : currentAthlete);
                    const credential = firebase.auth.EmailAuthProvider.credential(syntheticEmail, currentPassword);

                    await currentUser.reauthenticateWithCredential(credential);
                    console.log('âœ… Re-authenticated successfully');

                    // Update password in Firebase Auth
                    await currentUser.updatePassword(newPassword);
                    console.log('âœ… Password updated in Firebase Auth');
                } else {
                    throw new Error('No authenticated user');
                }

                // Also update in database for backward compatibility (optional, may fail due to permissions)
                try {
                    await setStoredPassword(currentAthlete, newPassword);
                    console.log('âœ… Password also saved to database');
                } catch (dbError) {
                    console.warn('Could not save password to database (non-critical):', dbError);
                    // This is not critical - the Firebase Auth password is what matters for login
                }

                alert('Password changed successfully!');
                closePasswordModal();

            } catch (error) {
                console.error('Error changing password:', error);

                if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    alert('Current password is incorrect');
                } else if (error.code === 'auth/weak-password') {
                    alert('New password must be at least 6 characters');
                } else if (error.code === 'auth/requires-recent-login') {
                    alert('For security, please log out and log back in before changing your password.');
                } else {
                    alert('Failed to change password. Please try again.');
                }
            }
        }
        
        // Firebase Auth State Listener
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log('User is signed in:', user.uid);
                currentUser = user;

                // Get role from database
                try {
                    const roleData = await getUserRole(user.uid);
                    if (roleData) {
                        currentRole = roleData.role;
                        currentAthlete = roleData.athleteName || (roleData.role === 'admin' ? 'ALL' : null);
                        currentOrganization = roleData.organizationId || null;
                        console.log('User role:', currentRole);

                        // Auto-restore dashboard on page load/refresh if user is already logged in
                        const dashboard = document.getElementById('dashboard');
                        const orgDashboard = document.getElementById('organizationDashboard');
                        const isDashboardVisible = dashboard && dashboard.style.display === 'block';
                        const isOrgDashboardVisible = orgDashboard && orgDashboard.style.display === 'block';

                        if (!isDashboardVisible && !isOrgDashboardVisible) {
                            console.log('Restoring user session...');

                            try {
                                if (roleData.role === 'organization' && roleData.organizationId) {
                                    window.currentOrgName = roleData.organizationId;
                                    await showOrganizationDashboard(roleData.organizationId);
                                } else if (roleData.role === 'admin' || roleData.role === 'athlete') {
                                    const athleteToShow = roleData.role === 'admin' ? 'Admin' : roleData.athleteName;
                                    window.currentAccessCode = roleData.role === 'admin' ? 'ALL' : roleData.athleteName;
                                    await showDashboard(athleteToShow);
                                }
                            } catch (dashboardError) {
                                console.error('Error restoring dashboard:', dashboardError);
                                // Hide loading and show login on error
                                showLoading(false);
                                showLogin();
                                alert('Error restoring session. Please log in again.');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error getting user role:', error);
                    showLoading(false);
                    showLogin();
                }
            } else {
                console.log('User is signed out');
                currentUser = null;
                currentRole = null;
            }
        });

        window.onload = async function() {
            try {
                showLoading(true);
                // Load athlete names for login autocomplete
                await loadAthletes();
                await populateOrganizationSelects();

                // Wait for auth state to be determined before showing login/dashboard
                // The onAuthStateChanged listener will handle showing the appropriate screen
                console.log('Page loaded, waiting for auth state...');

                // Small delay to let onAuthStateChanged fire
                setTimeout(() => {
                    // Only show login if no user is authenticated
                    if (!currentUser) {
                        showLoading(false);
                        showLogin();
                        setupSearch();
                    }
                    // If user is authenticated, onAuthStateChanged will have already shown dashboard
                }, 500);
            } catch (error) {
                console.error('Initialization error:', error);
                // Show login anyway - athletes list is optional for autocomplete
                showLoading(false);
                showLogin();
                setupSearch();
            }
        };

        // Load all portal data after successful authentication
        async function loadPortalData() {
            try {
                console.log('Loading portal data for authenticated user...');
                await loadAccessCodes();
                await loadRoyaltyData();
                await loadAthletes(); // Reload with authenticated access
                processData();
                await loadAllOrganizations();
                await loadAthleteOrganizations();
                await loadAllAthleteNotes();
                console.log('âœ… Portal data loaded successfully');
            } catch (error) {
                console.error('Error loading portal data:', error);
                throw error;
            }
        }
        
        async function loadAccessCodes() {
            try {
                // NOTE: accessCodes collection is now deprecated (using Firebase Auth)
                // We only load from athletes collection for backward compatibility with admin UI

                accessCodes = {};

                // Load access codes from athletes collection
                // This ensures athletes created via the portal have their access codes available
                // (Used by admin user management UI)
                try {
                    const athletesSnapshot = await database.ref('athletes').once('value');
                    const athletesObj = athletesSnapshot.val() || {};

                    Object.values(athletesObj).forEach(athlete => {
                        if (athlete && athlete.name && athlete.accessCode) {
                            accessCodes[athlete.name] = athlete.accessCode;
                        }
                    });

                    console.log('Access codes loaded from athletes:', Object.keys(accessCodes).length);
                } catch (athletesError) {
                    console.warn('Could not load access codes from athletes collection:', athletesError.message);
                }

                console.log('Access codes loaded:', Object.keys(accessCodes).length, 'athletes');
            } catch (error) {
                console.error('Error loading access codes:', error);
                throw error;
            }
        }

        async function loadRoyaltyData() {
            try {
                // Load all sales data from Firebase
                const snapshot = await database.ref('royaltyData').once('value');
                const rawData = snapshot.val() || [];

                // Handle both array and object formats
                if (Array.isArray(rawData)) {
                    // Old format from migration (array)
                    allData = rawData;
                } else {
                    // New format from Zapier (object with keys)
                    allData = Object.values(rawData);
                }

                console.log(`Loaded ${allData.length} sales records from Firebase`);
            } catch (error) {
                console.error('Error loading royalty data:', error);
                throw error;
            }
        }

        async function loadAthletes() {
            try {
                const athleteSet = new Set();
                let athletesFromCollection = 0;
                let athletesFromSales = 0;
                let athletesFromAccessCodes = 0;
                let athletesFromNameMapping = 0;

                // 1. Load from Firebase athletes collection (PRIMARY SOURCE)
                try {
                    const athletesSnapshot = await database.ref('athletes').once('value');
                    const athletesObj = athletesSnapshot.val() || {};
                    console.log('Raw athletes collection:', Object.keys(athletesObj).length, 'entries');

                    Object.entries(athletesObj).forEach(([key, a]) => {
                        if (a && a.name) {
                            athleteSet.add(a.name);
                            athletesFromCollection++;
                            console.log('Loaded athlete from collection:', a.name, '(key:', key, ')');
                        } else {
                            console.warn('Athlete entry missing name:', key, a);
                        }
                    });
                } catch (error) {
                    console.warn('Could not load athletes collection:', error);
                }

                // 2. Load from sales data (royaltyData)
                allData.forEach(row => {
                    if (row.athlete_name && !athleteSet.has(row.athlete_name)) {
                        athleteSet.add(row.athlete_name);
                        athletesFromSales++;
                    }
                });

                // 3. Load from access codes
                Object.keys(accessCodes).forEach(name => {
                    if (name !== 'Admin' && name !== 'admin' && !athleteSet.has(name)) {
                        athleteSet.add(name);
                        athletesFromAccessCodes++;
                    }
                });

                // 4. Load from name mapping (ensures all mapped names are available)
                try {
                    const nameMappingSnapshot = await database.ref('nameMapping').once('value');
                    const nameMapping = nameMappingSnapshot.val() || {};
                    Object.values(nameMapping).forEach(name => {
                        if (name && !athleteSet.has(name)) {
                            athleteSet.add(name);
                            athletesFromNameMapping++;
                        }
                    });
                } catch (error) {
                    console.warn('Could not load name mapping:', error);
                }

                // Convert to sorted array
                athletesList = Array.from(athleteSet).sort();

                // Always add Admin option for admin login
                athletesList.unshift('Admin (View All)');

                console.log('Athletes loaded:', athletesList.length, 'total athletes');
                console.log('  - From athletes collection:', athletesFromCollection);
                console.log('  - From sales data:', athletesFromSales);
                console.log('  - From access codes:', athletesFromAccessCodes);
                console.log('  - From name mapping:', athletesFromNameMapping);
                console.log('Full athlete list:', athletesList.join(', '));
            } catch (error) {
                console.error('Error loading athletes:', error);
                athletesList = ['Admin (View All)'];
            }
        }

        // Migration Helper: Create athletes collection and salesByAthlete index from existing data
        // This ensures all data is properly structured for Zapier integration
        async function migrateToNewStructure() {
            try {
                console.log('Starting migration to new structure...');

                // Load existing access codes and name mapping
                const codesSnapshot = await database.ref('accessCodes').once('value');
                const sanitizedCodes = codesSnapshot.val() || {};

                const mappingSnapshot = await database.ref('nameMapping').once('value');
                const nameMapping = mappingSnapshot.val() || {};

                // Load existing sales data to calculate totals
                const salesSnapshot = await database.ref('royaltyData').once('value');
                const rawSalesData = salesSnapshot.val() || [];

                // Handle both array and object formats
                let salesData;
                if (Array.isArray(rawSalesData)) {
                    // Old format from CSV migration (array)
                    salesData = rawSalesData;
                } else {
                    // New format from Zapier (object with keys)
                    salesData = Object.values(rawSalesData);
                }

                console.log('Found', salesData.length, 'sales records to process');

                // Track new mappings that need to be saved
                const updatedNameMapping = { ...nameMapping };

                // Calculate total sales per athlete
                const athleteSales = {};
                salesData.forEach(sale => {
                    const name = sale.athlete_name;
                    if (name) {
                        if (!athleteSales[name]) {
                            athleteSales[name] = 0;
                        }
                        athleteSales[name] += sale.final_royalty || 0;
                    }
                });

                // Create athletes collection
                const athletes = {};
                const salesByAthlete = {};

                Object.keys(sanitizedCodes).forEach(sanitizedName => {
                    const athleteName = nameMapping[sanitizedName] || sanitizedName;
                    const accessCode = sanitizedCodes[sanitizedName];

                    // Skip Admin
                    if (athleteName.toLowerCase().includes('admin')) {
                        return;
                    }

                    // Ensure nameMapping is updated
                    updatedNameMapping[sanitizedName] = athleteName;

                    athletes[sanitizedName] = {
                        name: athleteName,
                        sanitizedName: sanitizedName,
                        email: "",
                        createdAt: new Date().toISOString(),
                        createdFrom: "migration",
                        asanaProjectId: "",
                        hasAccessCode: true,
                        accessCode: accessCode,
                        totalSales: athleteSales[athleteName] || 0,
                        organization: null
                    };
                });

                // Upload athletes collection
                await database.ref('athletes').set(athletes);
                console.log('âœ“ Athletes collection created:', Object.keys(athletes).length, 'athletes');

                // Create salesByAthlete index
                salesData.forEach(sale => {
                    const athleteName = sale.athlete_name;
                    if (!athleteName) return;

                    // Ensure the athlete_name field is always the original, non-sanitized name
                    // This is critical for proper data display and Zapier integration

                    // Find sanitized name using consistent sanitization
                    let sanitizedName = null;
                    for (let sn in updatedNameMapping) {
                        if (updatedNameMapping[sn] === athleteName) {
                            sanitizedName = sn;
                            break;
                        }
                    }

                    if (!sanitizedName) {
                        // Generate it using the consistent sanitizeFirebaseKey function
                        sanitizedName = sanitizeFirebaseKey(athleteName);
                        // Save this new mapping
                        updatedNameMapping[sanitizedName] = athleteName;
                        console.log('Created new mapping:', sanitizedName, '->', athleteName);
                    }

                    if (!salesByAthlete[sanitizedName]) {
                        salesByAthlete[sanitizedName] = {};
                    }

                    // Sanitize import_id to remove invalid Firebase characters
                    const sanitizedImportId = sanitizeFirebaseKey(sale.import_id || '');

                    // Store the sale with the original athlete_name intact
                    salesByAthlete[sanitizedName][sanitizedImportId] = {
                        ...sale,
                        athlete_name: athleteName  // Ensure original name is preserved
                    };
                });

                // Upload salesByAthlete index
                await database.ref('salesByAthlete').set(salesByAthlete);
                console.log('âœ“ Sales indexed by athlete');

                // Update nameMapping in Firebase with any new mappings
                await database.ref('nameMapping').set(updatedNameMapping);
                console.log('âœ“ Name mapping updated:', Object.keys(updatedNameMapping).length, 'mappings');

                console.log('âœ“ Migration to new structure complete!');
                alert(`New structure created!\n\nAthletes: ${Object.keys(athletes).length}\nSales indexed: ${salesData.length}\n\nYou can now use Zapier to add new athletes and sales.`);
            } catch (error) {
                console.error('Migration error:', error);
                alert('Migration failed: ' + error.message);
            }
        }

        // Helper function to sync access_codes.json to Firebase with proper sanitization
        // This creates the correct nameMapping for all athletes
        async function syncAccessCodesToFirebase() {
            try {
                console.log('Starting access codes sync to Firebase...');

                // This should be loaded from access_codes.json
                // In production, you would fetch this from the JSON file
                const accessCodesFromJSON = {}; // Placeholder - manually populate or fetch from JSON

                if (Object.keys(accessCodesFromJSON).length === 0) {
                    const message = 'This function requires access_codes.json data.\n\n' +
                        'To use this function:\n' +
                        '1. Copy the contents of access_codes.json\n' +
                        '2. In the browser console, run:\n' +
                        '   syncAccessCodesWithData(YOUR_JSON_DATA)\n\n' +
                        'Example:\n' +
                        '   syncAccessCodesWithData({"John Doe": "JD2025", "Jane Smith": "JS2025"})';
                    console.log(message);
                    alert(message);
                    return;
                }

                await syncAccessCodesWithData(accessCodesFromJSON);
            } catch (error) {
                console.error('Sync error:', error);
                alert('Sync failed: ' + error.message);
            }
        }

        // Sync access codes with data - can be called directly with JSON data
        async function syncAccessCodesWithData(accessCodesData) {
            try {
                console.log('Syncing', Object.keys(accessCodesData).length, 'access codes...');

                const sanitizedCodes = {};
                const nameMapping = {};

                // Process each athlete name and code
                Object.entries(accessCodesData).forEach(([originalName, code]) => {
                    // Skip if this is admin or empty
                    if (!originalName || originalName.toLowerCase() === 'admin') {
                        console.log('Skipping admin/empty entry');
                        return;
                    }

                    // Sanitize the name for use as Firebase key
                    const sanitizedName = sanitizeFirebaseKey(originalName);

                    // Store the sanitized code and create the mapping
                    sanitizedCodes[sanitizedName] = code;
                    nameMapping[sanitizedName] = originalName;

                    console.log('Mapped:', sanitizedName, '->', originalName, '(', code, ')');
                });

                // Upload to Firebase
                await database.ref('accessCodes').set(sanitizedCodes);
                console.log('âœ“ Access codes uploaded:', Object.keys(sanitizedCodes).length);

                await database.ref('nameMapping').set(nameMapping);
                console.log('âœ“ Name mapping uploaded:', Object.keys(nameMapping).length);

                alert(
                    `Access codes synced successfully!\n\n` +
                    `Athletes synced: ${Object.keys(sanitizedCodes).length}\n` +
                    `Name mappings created: ${Object.keys(nameMapping).length}\n\n` +
                    `All athlete names with special characters (periods, slashes, etc.) ` +
                    `are now properly mapped for Firebase storage.`
                );
            } catch (error) {
                console.error('Sync error:', error);
                throw error;
            }
        }

        // Repair function: Fix athletes with spaces in their keys
        // This migrates athletes from keys with spaces to properly sanitized keys
        async function repairAthletesWithSpaces() {
            try {
                console.log('Starting repair of athletes with spaces in keys...');

                const collections = [
                    'athletes',
                    'accessCodes',
                    'nameMapping',
                    'athleteOrganizations',
                    'customPasswords',
                    'athleteNotes'
                ];

                const updates = {};
                const deletes = [];
                let repairedCount = 0;

                // Check each collection for keys with spaces
                for (const collectionName of collections) {
                    console.log(`Checking ${collectionName}...`);
                    const snapshot = await database.ref(collectionName).once('value');
                    const data = snapshot.val() || {};

                    Object.keys(data).forEach(key => {
                        // Check if key has spaces
                        if (key.includes(' ')) {
                            const sanitizedKey = sanitizeFirebaseKey(key);
                            const value = data[key];

                            console.log(`  Found: "${key}" -> "${sanitizedKey}"`);

                            // For athletes collection, update the sanitizedName field
                            if (collectionName === 'athletes' && value) {
                                value.sanitizedName = sanitizedKey;
                            }

                            // Add to updates (will create or overwrite at correct key)
                            updates[`${collectionName}/${sanitizedKey}`] = value;

                            // Mark old key for deletion
                            deletes.push(`${collectionName}/${key}`);

                            repairedCount++;
                        }
                    });
                }

                if (repairedCount === 0) {
                    console.log('âœ“ No athletes with spaces found - all data is clean!');
                    alert('No repairs needed - all athlete data is properly formatted!');
                    return;
                }

                console.log(`Found ${repairedCount} entries to repair`);
                console.log('Applying updates...');

                // Apply all updates
                await database.ref().update(updates);
                console.log('âœ“ Updates applied');

                // Delete old entries
                console.log('Removing old entries...');
                for (const path of deletes) {
                    await database.ref(path).remove();
                }
                console.log('âœ“ Old entries removed');

                alert(
                    `Repair complete!\n\n` +
                    `Fixed ${repairedCount} entries across ${collections.length} collections.\n\n` +
                    `Athletes with spaces in their names have been migrated to properly ` +
                    `sanitized keys (spaces replaced with underscores).\n\n` +
                    `Please refresh the page to see the changes.`
                );

                console.log('âœ“ Repair complete! Please refresh the page.');
            } catch (error) {
                console.error('Repair error:', error);
                alert('Repair failed: ' + error.message);
            }
        }

        // Make migration functions accessible from console
        window.migrateToNewStructure = migrateToNewStructure;
        window.syncAccessCodesToFirebase = syncAccessCodesToFirebase;
        window.syncAccessCodesWithData = syncAccessCodesWithData;
        window.repairAthletesWithSpaces = repairAthletesWithSpaces;

        function processData() {
            athleteData = {};

            // Build athleteData mapping (athlete name -> sales records)
            allData.forEach(row => {
                const athlete = row.athlete_name;
                if (athlete) {
                    if (!athleteData[athlete]) {
                        athleteData[athlete] = [];
                    }
                    athleteData[athlete].push(row);
                }
            });

            // DO NOT overwrite athletesList here!
            // athletesList was already populated by loadAthletes() with all athletes from Firebase
            // This function should only populate athleteData, not rebuild athletesList
            // Otherwise athletes without sales data (like newly created athletes) disappear from login

            console.log('Sales data processed for', Object.keys(athleteData).length, 'athletes with sales');
        }
        
        function setupSearch() {
            const searchInput = document.getElementById('athleteSearch');
            const suggestionsDiv = document.getElementById('suggestions');
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length < 2) {
                    suggestionsDiv.classList.remove('active');
                    suggestionsDiv.innerHTML = '';
                    selectedSuggestionIndex = -1;
                    updateLoginButton();
                    return;
                }
                
                const matches = athletesList.filter(athlete => 
                    athlete.toLowerCase().includes(query)
                );
                
                if (matches.length > 0) {
                    suggestionsDiv.innerHTML = matches.map((athlete, index) => 
                        `<div class="suggestion" data-index="${index}" data-athlete="${athlete}">${athlete}</div>`
                    ).join('');
                    suggestionsDiv.classList.add('active');
                } else {
                    suggestionsDiv.innerHTML = '<div class="no-results">No icons found</div>';
                    suggestionsDiv.classList.add('active');
                }
                
                selectedSuggestionIndex = -1;
                updateLoginButton();
            });
            
            searchInput.addEventListener('keydown', function(e) {
                const suggestions = document.querySelectorAll('.suggestion');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
                    updateSuggestionHighlight(suggestions);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                    updateSuggestionHighlight(suggestions);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedSuggestionIndex >= 0 && suggestions[selectedSuggestionIndex]) {
                        selectAthlete(suggestions[selectedSuggestionIndex].dataset.athlete);
                    } else if (!document.getElementById('loginBtn').disabled) {
                        login();
                    }
                } else if (e.key === 'Escape') {
                    suggestionsDiv.classList.remove('active');
                    selectedSuggestionIndex = -1;
                }
            });
            
            suggestionsDiv.addEventListener('click', function(e) {
                if (e.target.classList.contains('suggestion')) {
                    selectAthlete(e.target.dataset.athlete);
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.classList.remove('active');
                }
            });
            
            document.getElementById('accessCode').addEventListener('input', updateLoginButton);

            // Setup referral search
            const referralSearchInput = document.getElementById('referralSearchInput');
            if (referralSearchInput) {
                referralSearchInput.addEventListener('input', function() {
                    searchReferrals(this.value);
                });
            }
        }
        
        function updateSuggestionHighlight(suggestions) {
            suggestions.forEach((s, index) => {
                s.classList.toggle('highlighted', index === selectedSuggestionIndex);
            });
        }
        
        function selectAthlete(athleteName) {
            document.getElementById('athleteSearch').value = athleteName;
            document.getElementById('suggestions').classList.remove('active');
            selectedSuggestionIndex = -1;
            updateLoginButton();
            document.getElementById('accessCode').focus();
        }
        
        function updateLoginButton() {
            const athleteName = document.getElementById('athleteSearch').value.trim();
            const accessCode = document.getElementById('accessCode').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            
            const athleteExists = athletesList.some(a => 
                a.toLowerCase() === athleteName.toLowerCase()
            );
            
            loginBtn.disabled = !(athleteName && accessCode && athleteExists);
        }
        
        function generatePasswordFromName(athleteName) {
            // Generate password format: [FirstInitial][LastInitial]2025
            // Handle names like "Admin (View All)" by cleaning them first
            const cleanName = athleteName.replace(/\s*\(.*?\)\s*/g, '').trim();

            // Split the name into parts
            const nameParts = cleanName.split(/\s+/).filter(part => part.length > 0);

            if (nameParts.length < 2) {
                // If only one name part, use first two letters
                if (nameParts[0] && nameParts[0].length >= 2) {
                    return (nameParts[0][0] + nameParts[0][1]).toUpperCase() + '2025';
                } else if (nameParts[0]) {
                    return (nameParts[0][0] + nameParts[0][0]).toUpperCase() + '2025';
                }
                return null;
            }

            // Use first initial of first name and first initial of last name
            const firstInitial = nameParts[0][0].toUpperCase();
            const lastInitial = nameParts[nameParts.length - 1][0].toUpperCase();

            return firstInitial + lastInitial + '2025';
        }

        async function login() {
            const athleteName = document.getElementById('athleteSearch').value.trim();
            const code = document.getElementById('accessCode').value.trim();

            console.log('Login attempt for:', athleteName);
            console.log('Available athletes:', athletesList.length);

            let exactMatch = athletesList.find(a =>
                a.toLowerCase() === athleteName.toLowerCase()
            );

            if (!exactMatch) {
                console.error('Athlete not found in list:', athleteName);
                console.log('Checking if athlete exists in Firebase...');

                // Try to find in Firebase athletes collection as a fallback
                try {
                    const athletesSnapshot = await database.ref('athletes').once('value');
                    const athletesObj = athletesSnapshot.val() || {};

                    const foundInFirebase = Object.values(athletesObj).find(a =>
                        a && a.name && a.name.toLowerCase() === athleteName.toLowerCase()
                    );

                    if (foundInFirebase) {
                        console.error('CRITICAL: Athlete exists in Firebase but not in athletesList!');
                        console.error('This indicates a data loading issue. Please refresh the page.');
                        alert('ICON found in database but not loaded properly. Please refresh the page and try again.\n\nIf this persists, contact support.');
                    } else {
                        alert('ICON not found. Please select from the suggestions.');
                    }
                } catch (fbError) {
                    console.error('Error checking Firebase:', fbError);
                    alert('ICON not found. Please select from the suggestions.');
                }
                return;
            }

            console.log('Exact match found:', exactMatch);

            const isAdmin = exactMatch === 'Admin (View All)';
            const ADMIN_PASSWORD = 'ADMIN2025';
            const initialsPassword = generatePasswordFromName(exactMatch);
            const syntheticEmail = nameToEmail(exactMatch);

            console.log('ðŸ” Firebase Auth Email:', syntheticEmail);

            try {
                // Try to sign in first (most common case)
                let userCredential;
                let isNewAccount = false;

                try {
                    console.log('Attempting to sign in with Firebase Auth');
                    userCredential = await auth.signInWithEmailAndPassword(syntheticEmail, code);
                    console.log('âœ… Logged in successfully with existing Firebase Auth account');
                } catch (signInError) {
                    console.log('Sign-in error code:', signInError.code);

                    // Firebase returns auth/invalid-credential or auth/user-not-found when account doesn't exist
                    // For security, Firebase often uses invalid-credential to avoid revealing if email exists
                    if (signInError.code === 'auth/user-not-found' || signInError.code === 'auth/invalid-credential') {
                        // Account might not exist - try to create it (lazy migration)
                        console.log(`Account not found or invalid credential - attempting to create account for ${exactMatch}`);

                        // Verify the code is valid before creating account
                        const storedPassword = await getStoredPassword(exactMatch);
                        const isValidCode =
                            code === ADMIN_PASSWORD ||
                            (storedPassword && code === storedPassword) ||
                            (!storedPassword && initialsPassword && code.toUpperCase() === initialsPassword);

                        if (!isValidCode) {
                            alert('Invalid access code. Please try again.');
                            return;
                        }

                        // Create Firebase Auth account with synthetic email
                        try {
                            // Hide login section and show creating account message
                            document.getElementById('loginSection').style.display = 'none';
                            showLoading(true, 'Creating Account...', 'Setting up your account, please wait...');

                            userCredential = await auth.createUserWithEmailAndPassword(syntheticEmail, code);
                            isNewAccount = true;
                            console.log('âœ… Firebase Auth account created successfully');

                            // Wait for account and auth token to fully propagate
                            // Firebase Auth tokens can take 2-4 seconds to sync with Realtime Database
                            console.log('Waiting for Firebase Auth token to propagate...');
                            await new Promise(resolve => setTimeout(resolve, 4000));
                        } catch (createError) {
                            // Hide loading and show login again on error
                            showLoading(false);
                            document.getElementById('loginSection').style.display = 'block';

                            if (createError.code === 'auth/email-already-in-use') {
                                // Account exists but password is wrong
                                console.error('Account exists with different password');
                                alert('Invalid access code. If you previously set a custom password, please use that password.\n\nIf you forgot your password, contact your administrator.');
                                return;
                            }
                            throw createError;
                        }
                    } else if (signInError.code === 'auth/wrong-password') {
                        // Wrong password
                        alert('Invalid access code. Please try again.');
                        return;
                    } else {
                        // Other sign-in error
                        throw signInError;
                    }
                }

                const user = userCredential.user;

                // Get or set role
                let role;
                let roleData = await getUserRole(user.uid);

                if (roleData) {
                    // Role already exists
                    role = roleData.role;
                } else {
                    // New account - set role in database with retry logic
                    role = isAdmin ? 'admin' : 'athlete';

                    // Retry setting role if it fails (common on first login due to token propagation)
                    // This is non-blocking - if it fails, we still let the user proceed
                    let roleSetSuccess = false;
                    for (let attempt = 1; attempt <= 5; attempt++) {
                        try {
                            console.log(`Setting user role in database (attempt ${attempt})...`);
                            await setUserRoleInDatabase(user.uid, role, isAdmin ? null : exactMatch);
                            roleSetSuccess = true;
                            console.log('âœ… User role set successfully');
                            break;
                        } catch (roleError) {
                            console.error(`Attempt ${attempt} to set role failed:`, roleError);
                            if (attempt < 5) {
                                console.log('Retrying in 1.5 seconds...');
                                await new Promise(resolve => setTimeout(resolve, 1500));
                            } else {
                                console.warn('âš ï¸ Failed to set user role after 5 attempts. Role will be set on next login.');
                                // Don't throw - allow user to proceed anyway
                            }
                        }
                    }
                }

                // Store current user state
                currentUser = user;
                currentRole = role;
                currentAthlete = isAdmin ? 'ALL' : exactMatch;
                window.currentAccessCode = isAdmin ? 'ALL' : exactMatch;
                window.currentOrgName = null;

                // Show dashboard
                if (isAdmin || role === 'admin') {
                    await showDashboard('Admin');
                    // Prompt to change password if using default and new account
                    if (isNewAccount && code === ADMIN_PASSWORD) {
                        usedDefaultPassword = true;
                        setTimeout(() => openFirstLoginModal(), 500);
                    }
                } else {
                    await showDashboard(exactMatch);
                    // Prompt to change password if using initials password and new account
                    if (isNewAccount) {
                        const storedPassword = await getStoredPassword(exactMatch);
                        if (!storedPassword && initialsPassword && code.toUpperCase() === initialsPassword) {
                            usedDefaultPassword = true;
                            setTimeout(() => openFirstLoginModal(), 500);
                        }
                    }
                }

            } catch (error) {
                console.error('Login error:', error);

                // Hide loading and show login section again on error
                showLoading(false);
                document.getElementById('loginSection').style.display = 'block';

                if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    alert('Invalid access code. Please try again.\n\nIf this is your first login and you keep getting this error, the account may have been created with a different password during testing. Contact your administrator to reset your account.');
                } else if (error.code === 'auth/too-many-requests') {
                    alert('Too many failed login attempts. Please try again later or contact your administrator.');
                } else if (error.code === 'auth/weak-password') {
                    alert('Password must be at least 6 characters.');
                } else if (error.code === 'auth/email-already-in-use') {
                    alert('Account setup error. Please try logging in again.');
                } else {
                    alert('Login failed. Please try again.\n\nError: ' + (error.message || 'Unknown error'));
                }
            }
        }
        
        // Helper function to normalize boolean values from Zapier
        function normalizeBoolean(value) {
            if (value === true || value === 1 || value === '1') return true;
            if (value === false || value === 0 || value === '0') return false;
            // Handle string values (case-insensitive)
            if (typeof value === 'string') {
                const lower = value.toLowerCase();
                if (lower === 'true') return true;
                if (lower === 'false') return false;
            }
            return false;
        }

        // Helper function to get last 12 months in YYYY-MM format
        function getLast12Months() {
            const months = [];
            const today = new Date();

            for (let i = 11; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                months.push(`${year}-${month}`);
            }

            return months;
        }

        function calculateRoyalty(row) {
            const hasJersey20 = normalizeBoolean(row.has_jersey20);
            
            if (hasJersey20) {
                return 0;
            }
            
            const productName = (row.product_name || row.lineitem_name || '').toLowerCase();
            
            // Check for Mural Hoodie (but NOT Jersey Style Hoodie)
            if (productName.includes('mural hoodie') && !productName.includes('jersey style')) {
                return 10;
            }
            
            // Check for Mural Crewneck Sweatshirt
            if (productName.includes('mural crewneck sweatshirt') || productName.includes('mural crewneck')) {
                return 7;
            }
            
            // Check for Game Jersey
            const isGameJersey = normalizeBoolean(row.is_game_jersey);

            if (isGameJersey) {
                return 10;
            }
            
            // Default for all other items
            return 5;
        }
        
        async function showDashboard(athlete) {
            // Load all portal data now that user is authenticated
            try {
                showLoading(true);
                await loadPortalData();
                showLoading(false);
            } catch (error) {
                console.error('Error loading portal data:', error);
                alert('Failed to load dashboard data. Please refresh the page.');
                showLoading(false);
                return;
            }

            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

            // Show password change button for athlete logins
            const passwordBtn = document.querySelector('.change-password-btn');
            if (passwordBtn) passwordBtn.style.display = 'inline-block';

            document.getElementById('athleteName').textContent =
                athlete === 'Admin' ? 'Admin (All Icons)' : athlete;

            const data = currentAthlete === 'ALL' ? allData : (athleteData[athlete] || []);
            
            let totalRoyalties = 0;
            let gameJerseys = 0;
            let otherItems = 0;
            let jersey20Count = 0;
            const monthlyData = {};
            
            data.forEach(row => {
                const royalty = calculateRoyalty(row);
                row.calculated_royalty = royalty;
                totalRoyalties += royalty;

                const isGameJersey = normalizeBoolean(row.is_game_jersey);

                if (isGameJersey) {
                    gameJerseys++;
                } else {
                    otherItems++;
                }
                
                const hasJersey20 = normalizeBoolean(row.has_jersey20);

                if (hasJersey20) {
                    jersey20Count++;
                }
                
                const month = row.month_year || '2024-01';
                monthlyData[month] = (monthlyData[month] || 0) + royalty;
            });
            
            document.getElementById('totalRoyalties').textContent = `$${Math.round(totalRoyalties)}`;
            document.getElementById('totalOrders').textContent = data.length;
            document.getElementById('gameJerseys').textContent = gameJerseys;
            document.getElementById('otherItems').textContent = otherItems;
            
            if (jersey20Count > 0) {
                document.getElementById('jersey20Alert').style.display = 'block';
                document.getElementById('jersey20Count').textContent = jersey20Count;
            } else {
                document.getElementById('jersey20Alert').style.display = 'none';
            }
            
            const chartDiv = document.getElementById('monthChart');
            chartDiv.innerHTML = '';

            // Get last 12 months for rolling window
            const last12Months = getLast12Months();

            // Fill in monthly data for last 12 months (missing months = $0)
            const chartData = {};
            last12Months.forEach(month => {
                chartData[month] = monthlyData[month] || 0;
            });

            const values = Object.values(chartData);
            const maxValue = Math.max(...values, 1);

            if (values.some(v => v > 0)) {
                last12Months.forEach(month => {
                    const value = chartData[month];
                    const height = (value / maxValue) * 250;

                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    bar.style.height = `${Math.max(height, 20)}px`;
                    bar.innerHTML = `
                        <div class="bar-value">$${Math.round(value)}</div>
                        <div class="bar-label">${month}</div>
                    `;
                    chartDiv.appendChild(bar);
                });
            } else {
                chartDiv.innerHTML = '<p style="text-align: center; color: #999;">No monthly data available</p>';
            }
            
            // Sort by date (most recent first)
            window.tableData = data.slice().sort((a, b) => {
                const dateA = a.created_at ? new Date(a.created_at) : new Date(0);
                const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
                return dateB - dateA; // Descending order (newest first)
            });
            renderTable(window.tableData);

            // Hide tagged athletes panel for regular athlete logins
            document.getElementById('taggedAthletesPanel').style.display = 'none';

            // Show admin tools panel if user is admin
            if (currentAthlete === 'ALL') {
                document.getElementById('adminToolsPanel').style.display = 'block';
                loadAllCustomPasswords();
                refreshUserStatusTable();
                // Load organization data for admin
                loadAllOrganizations().then(() => {
                    loadAthleteOrganizations().then(() => {
                        refreshOrganizationsTable();
                        populateOrganizationSelects();
                    });
                });
                // Load all referrals for admin
                loadAllReferrals();
            } else {
                document.getElementById('adminToolsPanel').style.display = 'none';
            }

            // Load referrals for athletes (referrals content is now in the rewards panel)
            if (currentAthlete !== 'ALL') {
                loadUserReferrals(currentAthlete);
            }
        }

        function renderTable(data, resetPage = false) {
            // Store filtered data for pagination
            filteredTableData = data;

            if (resetPage) {
                currentPage = 1;
            }

            const tbody = document.getElementById('ordersTable');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No orders found</td></tr>';
                updatePaginationInfo(0, 0, 0);
                return;
            }

            // Calculate pagination
            const totalEntries = data.length;
            const entriesPerPage = pageSize === 'all' ? totalEntries : parseInt(pageSize);
            const totalPages = Math.ceil(totalEntries / entriesPerPage);

            // Ensure current page is valid
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            if (currentPage < 1) {
                currentPage = 1;
            }

            // Calculate slice indices
            const startIndex = (currentPage - 1) * entriesPerPage;
            const endIndex = pageSize === 'all' ? totalEntries : Math.min(startIndex + entriesPerPage, totalEntries);
            const pageData = data.slice(startIndex, endIndex);

            // Render rows
            pageData.forEach(row => {
                const tr = document.createElement('tr');
                const date = row.created_at ? new Date(row.created_at).toLocaleDateString() : 'N/A';
                const productName = row.product_name || row.lineitem_name || 'Unknown Product';

                // Calculate payout date (12th of the following month)
                let payoutDate = 'N/A';
                if (row.created_at) {
                    const orderDate = new Date(row.created_at);
                    const payoutMonth = new Date(orderDate.getFullYear(), orderDate.getMonth() + 1, 12);
                    payoutDate = payoutMonth.toLocaleDateString();
                }

                const hasJersey20 = normalizeBoolean(row.has_jersey20);

                // Check if this is organization view (has athlete_name field from organizationData)
                const productDisplay = row.athlete_name
                    ? `${row.athlete_name}<br><small style="color: #666;">${productName}</small>`
                    : productName;

                const royalty = row.calculated_royalty !== undefined
                    ? row.calculated_royalty
                    : (row.final_royalty !== undefined ? row.final_royalty : calculateRoyalty(row));

                tr.innerHTML = `
                    <td>${row.order_number || 'N/A'}</td>
                    <td>${productDisplay}</td>
                    <td>${date}</td>
                    <td>${payoutDate}</td>
                    <td>${hasJersey20 ? '<span class="badge badge-warning">JERSEY20</span>' : '-'}</td>
                    <td>$${royalty}</td>
                `;
                tbody.appendChild(tr);
            });

            // Update pagination info
            updatePaginationInfo(startIndex + 1, endIndex, totalEntries);
            updatePaginationButtons(currentPage, totalPages);
        }

        function updatePaginationInfo(start, end, total) {
            document.getElementById('showingRange').textContent = `${start}-${end}`;
            document.getElementById('totalEntries').textContent = total;

            const totalPages = pageSize === 'all' ? 1 : Math.ceil(total / parseInt(pageSize));
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        }

        function updatePaginationButtons(page, totalPages) {
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');

            prevBtn.disabled = page <= 1;
            nextBtn.disabled = page >= totalPages || pageSize === 'all';

            prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
            nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
            prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';
            nextBtn.style.cursor = nextBtn.disabled ? 'not-allowed' : 'pointer';
        }

        function changePageSize() {
            const select = document.getElementById('pageSize');
            pageSize = select.value;
            currentPage = 1;
            renderTable(filteredTableData);
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable(filteredTableData);
            }
        }

        function nextPage() {
            const totalPages = pageSize === 'all' ? 1 : Math.ceil(filteredTableData.length / parseInt(pageSize));
            if (currentPage < totalPages) {
                currentPage++;
                renderTable(filteredTableData);
            }
        }

        function filterTable() {
            const searchTerm = document.getElementById('tableSearch').value.toLowerCase();

            if (!searchTerm) {
                renderTable(window.tableData, true);
                return;
            }

            const filtered = window.tableData.filter(row => {
                const orderNum = (row.order_number || '').toString().toLowerCase();
                const productName = (row.product_name || '').toLowerCase();
                const lineitemName = (row.lineitem_name || '').toLowerCase();

                return orderNum.includes(searchTerm) ||
                       productName.includes(searchTerm) ||
                       lineitemName.includes(searchTerm);
            });

            renderTable(filtered, true);
        }
        
        async function logout() {
            try {
                // Sign out from Firebase Auth
                await auth.signOut();
                console.log('âœ… Signed out from Firebase Auth');
            } catch (error) {
                console.error('Error signing out:', error);
            }

            // Clear local state
            currentAthlete = '';
            currentOrganization = null;
            currentUser = null;
            currentRole = null;
            window.currentAccessCode = null;
            window.currentOrgName = null;

            // Reset UI
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('athleteSearch').value = '';
            document.getElementById('accessCode').value = '';
            document.getElementById('tableSearch').value = '';
            document.getElementById('loginBtn').disabled = true;
            document.getElementById('orgSelect').value = '';
            document.getElementById('orgPassword').value = '';

            // Switch back to athlete login
            switchLoginType('athlete');
        }
        
        function exportData() {
            let data;
            let filename;

            if (currentOrganization) {
                // Export organization data (use window.tableData which contains org athletes)
                data = window.tableData || [];
                filename = `${allOrganizations[currentOrganization].name}_royalties.csv`;
            } else if (currentAthlete === 'ALL') {
                data = allData;
                filename = 'all_icons_royalties.csv';
            } else {
                data = athleteData[currentAthlete];
                filename = `${currentAthlete}_royalties.csv`;
            }
            
            if (!data || data.length === 0) {
                alert('No data to export');
                return;
            }
            
            let csv = 'Order Number,Product,Date,Discount Code,Has JERSEY20,Royalty\n';
            data.forEach(row => {
                const date = row.created_at ? new Date(row.created_at).toLocaleDateString() : 'N/A';
                const productName = (row.product_name || row.lineitem_name || '').replace(/"/g, '""');
                const hasJersey20 = normalizeBoolean(row.has_jersey20);
                const royalty = row.calculated_royalty !== undefined ? row.calculated_royalty : calculateRoyalty(row);
                
                csv += `${row.order_number},"${productName}",${date},${row.discount_code || ''},${hasJersey20},${royalty}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // ========== ADMIN FUNCTIONS ==========

        // Load all custom passwords from Firebase
        async function loadAllCustomPasswords() {
            try {
                const snapshot = await database.ref('customPasswords').once('value');
                allCustomPasswords = snapshot.val() || {};
                console.log('Loaded custom passwords for', Object.keys(allCustomPasswords).length, 'users');
            } catch (error) {
                console.error('Error loading custom passwords:', error);
            }
        }

        // Filter admin user list as typing
        function filterAdminUsers() {
            const input = document.getElementById('adminUserSearch').value.toLowerCase();
            const suggestionsList = document.getElementById('adminUserList');

            if (!input) {
                suggestionsList.classList.remove('active');
                return;
            }

            const filtered = athletesList.filter(athlete =>
                athlete !== 'Admin (View All)' && athlete.toLowerCase().includes(input)
            ).slice(0, 10);

            if (filtered.length === 0) {
                suggestionsList.classList.remove('active');
                return;
            }

            suggestionsList.innerHTML = filtered.map(athlete =>
                `<div class="suggestion" onclick="selectAdminUser('${athlete.replace(/'/g, "\\'")}')">${athlete}</div>`
            ).join('');

            suggestionsList.classList.add('active');
        }

        // Select a user in admin panel
        async function selectAdminUser(userName) {
            selectedAdminUser = userName;
            document.getElementById('adminUserSearch').value = userName;
            document.getElementById('adminUserList').classList.remove('active');

            // Show user info section
            document.getElementById('selectedUserInfo').style.display = 'block';
            document.getElementById('selectedUserName').textContent = userName;

            // Get default password
            const defaultPwd = accessCodes[userName] || generatePasswordFromName(userName);
            document.getElementById('selectedUserDefaultPwd').textContent = defaultPwd;

            // Check if user has custom password
            const sanitizedName = sanitizeFirebaseKey(userName);
            const hasCustomPwd = allCustomPasswords[sanitizedName] ? 'Yes' : 'No';
            document.getElementById('selectedUserHasCustomPwd').textContent = hasCustomPwd;
            document.getElementById('selectedUserHasCustomPwd').style.color =
                allCustomPasswords[sanitizedName] ? '#28a745' : '#dc3545';

            // Load and display notes
            await loadAthleteNotes(userName);
        }

        // Reset user password to default
        async function resetUserPassword() {
            if (!selectedAdminUser) {
                alert('Please select a user first');
                return;
            }

            if (!confirm(`Reset password for ${selectedAdminUser} to their default password?`)) {
                return;
            }

            try {
                const sanitizedName = sanitizeFirebaseKey(selectedAdminUser);
                await database.ref('customPasswords/' + sanitizedName).remove();
                delete allCustomPasswords[sanitizedName];

                alert(`Password reset successfully! ${selectedAdminUser} can now login with their default password.`);
                selectAdminUser(selectedAdminUser); // Refresh display
                refreshUserStatusTable();
            } catch (error) {
                console.error('Error resetting password:', error);
                alert('Failed to reset password: ' + error.message);
            }
        }

        // Open modal to set custom password
        function setCustomPasswordForUser() {
            if (!selectedAdminUser) {
                alert('Please select a user first');
                return;
            }

            document.getElementById('adminPwdUserName').textContent = selectedAdminUser;
            document.getElementById('adminNewPassword').value = '';
            document.getElementById('adminConfirmPassword').value = '';
            document.getElementById('adminSetPasswordModal').style.display = 'block';
        }

        // Confirm and set custom password
        async function confirmSetCustomPassword() {
            const newPassword = document.getElementById('adminNewPassword').value;
            const confirmPassword = document.getElementById('adminConfirmPassword').value;

            if (!newPassword || !confirmPassword) {
                alert('Please fill in all fields');
                return;
            }

            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            try {
                await setStoredPassword(selectedAdminUser, newPassword);
                allCustomPasswords[sanitizeFirebaseKey(selectedAdminUser)] = newPassword;

                alert(`Custom password set successfully for ${selectedAdminUser}!`);
                closeAdminSetPasswordModal();
                selectAdminUser(selectedAdminUser); // Refresh display
                refreshUserStatusTable();
            } catch (error) {
                console.error('Error setting password:', error);
                alert('Failed to set password: ' + error.message);
            }
        }

        // View user's royalty data
        function viewUserData() {
            if (!selectedAdminUser) {
                alert('Please select a user first');
                return;
            }

            const userData = athleteData[selectedAdminUser] || [];

            document.getElementById('viewDataUserName').textContent = selectedAdminUser;

            // Calculate stats
            let totalRoyalties = 0;
            userData.forEach(row => {
                const royalty = calculateRoyalty(row);
                totalRoyalties += royalty;
            });

            document.getElementById('viewDataTotalRoyalties').textContent = `$${Math.round(totalRoyalties)}`;
            document.getElementById('viewDataTotalOrders').textContent = userData.length;

            // Count total units (could be same as orders if each row is one unit)
            document.getElementById('viewDataTotalUnits').textContent = userData.length;

            // Populate table
            const tbody = document.getElementById('viewDataTableBody');
            tbody.innerHTML = '';

            if (userData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No data found for this user</td></tr>';
            } else {
                userData.slice().reverse().forEach(row => {
                    const date = row.created_at ? new Date(row.created_at).toLocaleDateString() : 'N/A';
                    const productName = row.product_name || row.lineitem_name || 'Unknown';
                    const royalty = calculateRoyalty(row);

                    // Calculate payout date (12th of the following month)
                    let payoutDate = 'N/A';
                    if (row.created_at) {
                        const orderDate = new Date(row.created_at);
                        const payoutMonth = new Date(orderDate.getFullYear(), orderDate.getMonth() + 1, 12);
                        payoutDate = payoutMonth.toLocaleDateString();
                    }

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.order_number || 'N/A'}</td>
                        <td>${date}</td>
                        <td>${payoutDate}</td>
                        <td>${productName}</td>
                        <td>$${royalty}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            document.getElementById('adminViewDataModal').style.display = 'block';
        }

        // Refresh the all users status table
        async function refreshUserStatusTable() {
            const showOnlyCustom = document.getElementById('showOnlyCustomPwdUsers').checked;
            const tbody = document.getElementById('allUsersTableBody');
            tbody.innerHTML = '';

            // Filter out Admin and sort in descending order (Z to A)
            const users = athletesList
                .filter(athlete => athlete !== 'Admin (View All)')
                .sort((a, b) => b.localeCompare(a)); // Descending alphabetical order

            users.forEach(userName => {
                const sanitizedName = sanitizeFirebaseKey(userName);
                const hasCustomPwd = allCustomPasswords[sanitizedName];

                if (showOnlyCustom && !hasCustomPwd) {
                    return; // Skip users without custom passwords
                }

                const defaultPwd = accessCodes[userName] || generatePasswordFromName(userName);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${userName}</td>
                    <td><code>${defaultPwd}</code></td>
                    <td style="color: ${hasCustomPwd ? '#28a745' : '#999'};">
                        ${hasCustomPwd ? 'Yes' : 'No'}
                    </td>
                    <td>
                        <button class="btn" onclick="selectAdminUser('${userName.replace(/'/g, "\\'")}'); document.getElementById('adminUserSearch').scrollIntoView();"
                                style="padding: 5px 10px; font-size: 0.9em;">
                            Manage
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            if (tbody.children.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No users found</td></tr>';
            }
        }

        // Modal functions
        function closeAdminSetPasswordModal() {
            document.getElementById('adminSetPasswordModal').style.display = 'none';
        }

        function closeAdminViewDataModal() {
            document.getElementById('adminViewDataModal').style.display = 'none';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // ========== DATABASE CLEANUP FUNCTIONS ==========

        let duplicateAthletes = [];

        async function scanForDuplicateAthletes() {
            const statusDiv = document.getElementById('cleanupStatus');
            const statusMsg = document.getElementById('cleanupStatusMessage');
            const consolidateBtn = document.getElementById('consolidateBtn');

            statusDiv.style.display = 'block';
            statusMsg.textContent = 'Scanning database for duplicate athlete entries...';
            statusMsg.style.color = '#007bff';
            consolidateBtn.style.display = 'none';
            duplicateAthletes = [];

            try {
                const athletesSnapshot = await database.ref('athletes').once('value');
                const athletes = athletesSnapshot.val() || {};

                // Separate push ID entries from sanitized name entries
                const pushIdEntries = {};
                const nameEntries = {};

                Object.keys(athletes).forEach(key => {
                    if (key.startsWith('-')) {
                        // This is a push ID (auto-generated by Firebase)
                        pushIdEntries[key] = athletes[key];
                    } else {
                        // This is a sanitized name
                        nameEntries[key] = athletes[key];
                    }
                });

                const pushIdCount = Object.keys(pushIdEntries).length;

                if (pushIdCount === 0) {
                    statusMsg.textContent = 'âœ… No duplicate entries found! Your database is clean.';
                    statusMsg.style.color = '#28a745';
                    return;
                }

                // Store duplicates for consolidation
                duplicateAthletes = Object.keys(pushIdEntries).map(pushId => ({
                    pushId: pushId,
                    data: pushIdEntries[pushId],
                    sanitizedName: pushIdEntries[pushId].sanitizedName || sanitizeFirebaseKey(pushIdEntries[pushId].name)
                }));

                statusMsg.innerHTML = `âš ï¸ Found ${pushIdCount} duplicate athlete ${pushIdCount === 1 ? 'entry' : 'entries'} with push IDs.<br>` +
                    `These entries should be consolidated into their proper sanitized name entries.<br><br>` +
                    `<strong>Duplicates found:</strong><br>` +
                    duplicateAthletes.map(d => `- ${d.data.name} (Push ID: ${d.pushId} â†’ Should be: ${d.sanitizedName})`).join('<br>');
                statusMsg.style.color = '#856404';
                consolidateBtn.style.display = 'inline-block';

            } catch (error) {
                console.error('Error scanning for duplicates:', error);
                statusMsg.textContent = 'âŒ Error scanning database: ' + error.message;
                statusMsg.style.color = '#dc3545';
            }
        }

        async function consolidateDuplicateAthletes() {
            if (duplicateAthletes.length === 0) {
                alert('Please scan for duplicates first');
                return;
            }

            const confirmMsg = `This will consolidate ${duplicateAthletes.length} duplicate athlete ${duplicateAthletes.length === 1 ? 'entry' : 'entries'}.\n\n` +
                `For each duplicate:\n` +
                `1. Move referrals from push ID entry to sanitized name entry\n` +
                `2. Merge any missing data\n` +
                `3. Delete the push ID entry\n\n` +
                `This action cannot be undone. Continue?`;

            if (!confirm(confirmMsg)) {
                return;
            }

            const statusDiv = document.getElementById('cleanupStatus');
            const statusMsg = document.getElementById('cleanupStatusMessage');
            const consolidateBtn = document.getElementById('consolidateBtn');

            statusDiv.style.display = 'block';
            statusMsg.textContent = 'Consolidating duplicates...';
            statusMsg.style.color = '#007bff';
            consolidateBtn.disabled = true;

            let successCount = 0;
            let errorCount = 0;
            const errors = [];

            for (const duplicate of duplicateAthletes) {
                try {
                    const pushId = duplicate.pushId;
                    const sanitizedName = duplicate.sanitizedName;
                    const pushData = duplicate.data;

                    console.log(`Processing: ${pushData.name} (${pushId} â†’ ${sanitizedName})`);

                    // 1. Check if sanitized name entry exists
                    const sanitizedSnapshot = await database.ref('athletes/' + sanitizedName).once('value');
                    const sanitizedData = sanitizedSnapshot.val();

                    if (!sanitizedData) {
                        // If sanitized entry doesn't exist, move the whole push ID entry to sanitized name
                        await database.ref('athletes/' + sanitizedName).set(pushData);
                        console.log(`  âœ“ Moved entire entry to ${sanitizedName}`);
                    } else {
                        // If sanitized entry exists, only move referrals
                        const pushReferralsSnapshot = await database.ref('athletes/' + pushId + '/referrals').once('value');
                        const pushReferrals = pushReferralsSnapshot.val();

                        if (pushReferrals) {
                            // Get existing referrals from sanitized entry
                            const sanitizedReferralsSnapshot = await database.ref('athletes/' + sanitizedName + '/referrals').once('value');
                            const sanitizedReferrals = sanitizedReferralsSnapshot.val() || {};

                            // Merge referrals
                            const mergedReferrals = { ...sanitizedReferrals, ...pushReferrals };
                            await database.ref('athletes/' + sanitizedName + '/referrals').set(mergedReferrals);
                            console.log(`  âœ“ Merged ${Object.keys(pushReferrals).length} referrals to ${sanitizedName}`);
                        }
                    }

                    // 2. Delete the push ID entry
                    await database.ref('athletes/' + pushId).remove();
                    console.log(`  âœ“ Deleted push ID entry ${pushId}`);

                    successCount++;

                } catch (error) {
                    console.error(`Error processing ${duplicate.data.name}:`, error);
                    errorCount++;
                    errors.push(`${duplicate.data.name}: ${error.message}`);
                }
            }

            // Show results
            if (errorCount === 0) {
                statusMsg.innerHTML = `âœ… Successfully consolidated ${successCount} duplicate ${successCount === 1 ? 'entry' : 'entries'}!<br><br>` +
                    `Your database has been cleaned. Referrals have been moved to the correct athlete entries.`;
                statusMsg.style.color = '#28a745';
            } else {
                statusMsg.innerHTML = `âš ï¸ Completed with ${successCount} successes and ${errorCount} errors:<br><br>` +
                    errors.join('<br>');
                statusMsg.style.color = '#856404';
            }

            consolidateBtn.style.display = 'none';
            duplicateAthletes = [];

            // Reload admin data
            setTimeout(() => {
                location.reload();
            }, 3000);
        }

        // ========== END DATABASE CLEANUP FUNCTIONS ==========

        // ========== END ADMIN FUNCTIONS ==========

        // ========== ATHLETE NOTES FUNCTIONS ==========

        // Load notes for a specific athlete
        async function loadAthleteNotes(athleteName) {
            try {
                const sanitizedName = sanitizeFirebaseKey(athleteName);
                const snapshot = await database.ref('athleteNotes/' + sanitizedName).once('value');
                const notes = snapshot.val() || '';

                // Update local cache
                athleteNotes[sanitizedName] = notes;

                // Display in textarea
                const textarea = document.getElementById('athleteNotesTextarea');
                if (textarea) {
                    textarea.value = notes;
                }

                // Clear status
                const statusElement = document.getElementById('notesSaveStatus');
                if (statusElement) {
                    statusElement.textContent = '';
                }
            } catch (error) {
                console.error('Error loading athlete notes:', error);
            }
        }

        // Save notes for the currently selected athlete
        async function saveAthleteNotes() {
            if (!selectedAdminUser) {
                alert('Please select an athlete first');
                return;
            }

            const notes = document.getElementById('athleteNotesTextarea').value.trim();
            const statusElement = document.getElementById('notesSaveStatus');

            statusElement.textContent = 'Saving...';
            statusElement.style.color = '#007bff';

            try {
                const sanitizedName = sanitizeFirebaseKey(selectedAdminUser);

                if (notes) {
                    // Save notes to Firebase
                    await database.ref('athleteNotes/' + sanitizedName).set(notes);
                } else {
                    // Remove notes if empty
                    await database.ref('athleteNotes/' + sanitizedName).remove();
                }

                // Update local cache
                athleteNotes[sanitizedName] = notes;

                statusElement.textContent = 'âœ“ Saved';
                statusElement.style.color = '#28a745';

                // Clear status after 3 seconds
                setTimeout(() => {
                    statusElement.textContent = '';
                }, 3000);
            } catch (error) {
                console.error('Error saving athlete notes:', error);
                statusElement.textContent = 'Error: ' + error.message;
                statusElement.style.color = '#dc3545';
            }
        }

        // Load all athlete notes from Firebase
        async function loadAllAthleteNotes() {
            try {
                const snapshot = await database.ref('athleteNotes').once('value');
                athleteNotes = snapshot.val() || {};
                console.log('Loaded notes for', Object.keys(athleteNotes).length, 'athletes');
            } catch (error) {
                console.error('Error loading all athlete notes:', error);
                athleteNotes = {};
            }
        }

        // ========== ORGANIZATION MANAGEMENT FUNCTIONS ==========

        // Load all organizations from Firebase
        async function loadAllOrganizations() {
            try {
                const snapshot = await database.ref('organizations').once('value');
                allOrganizations = snapshot.val() || {};
                console.log('Loaded', Object.keys(allOrganizations).length, 'organizations');
                return allOrganizations;
            } catch (error) {
                console.error('Error loading organizations:', error);
                return {};
            }
        }

        // Load athlete-organization mappings from Firebase
        async function loadAthleteOrganizations() {
            try {
                const snapshot = await database.ref('athleteOrganizations').once('value');
                const sanitizedMappings = snapshot.val() || {};

                // Try to load name mapping to convert sanitized keys back to original names
                let nameMapping = {};
                try {
                    const mappingSnapshot = await database.ref('nameMapping').once('value');
                    nameMapping = mappingSnapshot.val() || {};
                } catch (mappingError) {
                    console.warn('Could not load name mapping, will attempt to match by sanitization:', mappingError.message);
                }

                // Convert sanitized keys back to original athlete names
                athleteOrganizations = {};
                Object.keys(sanitizedMappings).forEach(sanitizedKey => {
                    const orgId = sanitizedMappings[sanitizedKey];

                    // Try to get original name from mapping
                    let originalName = nameMapping[sanitizedKey];

                    // If no mapping, try to find matching athlete by comparing sanitized versions
                    if (!originalName && athletesList.length > 0) {
                        const matchingAthlete = athletesList.find(athlete =>
                            sanitizeFirebaseKey(athlete) === sanitizedKey
                        );
                        originalName = matchingAthlete;
                    }

                    // Fallback: convert underscores back to spaces
                    if (!originalName) {
                        originalName = sanitizedKey.replace(/_/g, ' ');
                    }

                    athleteOrganizations[originalName] = orgId;
                });

                console.log('Loaded', Object.keys(athleteOrganizations).length, 'athlete-organization mappings');
                return athleteOrganizations;
            } catch (error) {
                console.error('Error loading athlete organizations:', error);
                return {};
            }
        }

        // Create new organization
        async function createOrganization() {
            const name = document.getElementById('newOrgName').value.trim();
            const password = document.getElementById('newOrgPassword').value;
            const referralPerSale = parseFloat(document.getElementById('newOrgReferralPerSale').value) || 0;
            const bonusPercentage = parseFloat(document.getElementById('newOrgBonusPercentage').value) || 0;

            if (!name) {
                alert('Please enter an organization name');
                return;
            }

            if (!password || password.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }

            // Create organization ID from name (lowercase, replace spaces with underscores)
            const orgId = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');

            if (allOrganizations[orgId]) {
                alert('An organization with this name already exists');
                return;
            }

            try {
                const orgData = {
                    name: name,
                    password: password,
                    referralPerSale: referralPerSale,
                    bonusPercentage: bonusPercentage,
                    createdAt: Date.now()
                };

                await database.ref('organizations/' + orgId).set(orgData);
                allOrganizations[orgId] = orgData;

                alert(`Organization "${name}" created successfully!`);
                document.getElementById('newOrgName').value = '';
                document.getElementById('newOrgPassword').value = '';
                document.getElementById('newOrgReferralPerSale').value = '0';
                document.getElementById('newOrgBonusPercentage').value = '0';

                await refreshOrganizationsTable();
                await populateOrganizationSelects();
            } catch (error) {
                console.error('Error creating organization:', error);
                alert('Failed to create organization: ' + error.message);
            }
        }

        // Refresh organizations table
        async function refreshOrganizationsTable() {
            await loadAllOrganizations();
            await loadAthleteOrganizations();

            const tbody = document.getElementById('organizationsTableBody');
            tbody.innerHTML = '';

            const orgIds = Object.keys(allOrganizations).sort();

            if (orgIds.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No organizations found</td></tr>';
                return;
            }

            orgIds.forEach(orgId => {
                const org = allOrganizations[orgId];

                // Count tagged athletes
                const taggedAthletes = Object.keys(athleteOrganizations).filter(
                    athleteName => athleteOrganizations[athleteName] === orgId
                );

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${org.name}</td>
                    <td style="text-align: center;">$${(org.referralPerSale || 0).toFixed(2)}</td>
                    <td style="text-align: center;">${(org.bonusPercentage || 0)}%</td>
                    <td style="text-align: center;">${taggedAthletes.length} athlete(s)</td>
                    <td>
                        <button class="btn" onclick="viewOrganizationAthletes('${orgId}')" style="padding: 5px 10px; font-size: 0.9em; background: #17a2b8; margin-right: 5px;">
                            View Athletes
                        </button>
                        <button class="btn" onclick="editOrganization('${orgId}')" style="padding: 5px 10px; font-size: 0.9em; background: #28a745; margin-right: 5px;">
                            Edit
                        </button>
                        <button class="btn" onclick="deleteOrganization('${orgId}')" style="padding: 5px 10px; font-size: 0.9em; background: #dc3545;">
                            Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Edit organization
        function editOrganization(orgId) {
            const org = allOrganizations[orgId];
            if (!org) return;

            document.getElementById('editOrgId').value = orgId;
            document.getElementById('editOrgName').value = org.name;
            document.getElementById('editOrgPassword').value = '';
            document.getElementById('editOrgReferralPerSale').value = org.referralPerSale || 0;
            document.getElementById('editOrgBonusPercentage').value = org.bonusPercentage || 0;
            document.getElementById('editOrganizationModal').style.display = 'block';
        }

        // Confirm edit organization
        async function confirmEditOrganization() {
            const orgId = document.getElementById('editOrgId').value;
            const newName = document.getElementById('editOrgName').value.trim();
            const newPassword = document.getElementById('editOrgPassword').value;
            const referralPerSale = parseFloat(document.getElementById('editOrgReferralPerSale').value) || 0;
            const bonusPercentage = parseFloat(document.getElementById('editOrgBonusPercentage').value) || 0;

            if (!newName) {
                alert('Please enter an organization name');
                return;
            }

            try {
                const updates = {
                    name: newName,
                    referralPerSale: referralPerSale,
                    bonusPercentage: bonusPercentage
                };

                if (newPassword && newPassword.length >= 6) {
                    updates.password = newPassword;
                } else if (newPassword && newPassword.length < 6) {
                    alert('Password must be at least 6 characters long');
                    return;
                }

                await database.ref('organizations/' + orgId).update(updates);
                allOrganizations[orgId] = { ...allOrganizations[orgId], ...updates };

                alert('Organization updated successfully!');
                closeEditOrganizationModal();
                await refreshOrganizationsTable();
                await populateOrganizationSelects();
            } catch (error) {
                console.error('Error updating organization:', error);
                alert('Failed to update organization: ' + error.message);
            }
        }

        // Delete organization
        async function deleteOrganization(orgId) {
            const org = allOrganizations[orgId];
            if (!org) return;

            // Count tagged athletes
            const taggedAthletes = Object.keys(athleteOrganizations).filter(
                athleteName => athleteOrganizations[athleteName] === orgId
            );

            let confirmMsg = `Delete organization "${org.name}"?`;
            if (taggedAthletes.length > 0) {
                confirmMsg += `\n\nThis will also remove ${taggedAthletes.length} athlete tag(s).`;
            }

            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                // Delete organization
                await database.ref('organizations/' + orgId).remove();
                delete allOrganizations[orgId];

                // Remove all athlete tags for this organization
                if (taggedAthletes.length > 0) {
                    const updates = {};
                    taggedAthletes.forEach(athleteName => {
                        const sanitizedName = sanitizeFirebaseKey(athleteName);
                        updates['athleteOrganizations/' + sanitizedName] = null;
                        delete athleteOrganizations[athleteName];
                    });
                    await database.ref().update(updates);
                }

                alert('Organization deleted successfully!');
                await refreshOrganizationsTable();
                await populateOrganizationSelects();
            } catch (error) {
                console.error('Error deleting organization:', error);
                alert('Failed to delete organization: ' + error.message);
            }
        }

        // View organization athletes
        function viewOrganizationAthletes(orgId) {
            const org = allOrganizations[orgId];
            if (!org) return;

            document.getElementById('viewOrgAthletesName').textContent = org.name;

            // Get tagged athletes
            const taggedAthletes = Object.keys(athleteOrganizations).filter(
                athleteName => athleteOrganizations[athleteName] === orgId
            );

            const tbody = document.getElementById('viewOrgAthletesTableBody');
            tbody.innerHTML = '';

            if (taggedAthletes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No athletes tagged with this organization</td></tr>';
            } else {
                taggedAthletes.forEach(athleteName => {
                    const athleteSales = athleteData[athleteName] || [];
                    let totalRoyalties = 0;

                    athleteSales.forEach(row => {
                        totalRoyalties += calculateRoyalty(row);
                    });

                    // Get notes for this athlete
                    const sanitizedName = sanitizeFirebaseKey(athleteName);
                    const notes = athleteNotes[sanitizedName] || '';
                    const notesPreview = notes.length > 100 ? notes.substring(0, 100) + '...' : notes;
                    const notesDisplay = notes ? notesPreview : '<em style="color: #999;">No notes</em>';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${athleteName}</td>
                        <td>${athleteSales.length}</td>
                        <td>$${Math.round(totalRoyalties)}</td>
                        <td style="font-size: 0.85em; color: #666;">${notesDisplay}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            document.getElementById('viewOrgAthletesModal').style.display = 'block';
        }

        // Populate organization selects (for login and tagging)
        async function populateOrganizationSelects() {
            await loadAllOrganizations();

            const orgSelectLogin = document.getElementById('orgSelect');
            const orgTagSelect = document.getElementById('orgTagSelect');
            const newAthleteOrgSelect = document.getElementById('newAthleteOrganization');

            // Clear existing options (except first)
            orgSelectLogin.innerHTML = '<option value="">-- Select Organization --</option>';
            orgTagSelect.innerHTML = '<option value="">-- No Organization --</option>';
            if (newAthleteOrgSelect) {
                newAthleteOrgSelect.innerHTML = '<option value="">-- No Organization --</option>';
            }

            const orgIds = Object.keys(allOrganizations).sort((a, b) => {
                return allOrganizations[a].name.localeCompare(allOrganizations[b].name);
            });

            orgIds.forEach(orgId => {
                const org = allOrganizations[orgId];

                const optionLogin = document.createElement('option');
                optionLogin.value = orgId;
                optionLogin.textContent = org.name;
                orgSelectLogin.appendChild(optionLogin);

                const optionTag = document.createElement('option');
                optionTag.value = orgId;
                optionTag.textContent = org.name;
                orgTagSelect.appendChild(optionTag);

                // Add to manual athlete entry dropdown
                if (newAthleteOrgSelect) {
                    const optionNewAthlete = document.createElement('option');
                    optionNewAthlete.value = orgId;
                    optionNewAthlete.textContent = org.name;
                    newAthleteOrgSelect.appendChild(optionNewAthlete);
                }
            });
        }

        // Filter athlete tag list
        function filterAthleteTagList() {
            const input = document.getElementById('athleteTagSearch').value.toLowerCase();
            const suggestionsList = document.getElementById('athleteTagList');

            if (!input) {
                suggestionsList.classList.remove('active');
                return;
            }

            const filtered = athletesList.filter(athlete =>
                athlete !== 'Admin (View All)' && athlete.toLowerCase().includes(input)
            ).slice(0, 10);

            if (filtered.length === 0) {
                suggestionsList.classList.remove('active');
                return;
            }

            suggestionsList.innerHTML = filtered.map(athlete =>
                `<div class="suggestion" onclick="selectAthleteForTag('${athlete.replace(/'/g, "\\'")}')">${athlete}</div>`
            ).join('');

            suggestionsList.classList.add('active');
        }

        // Select athlete for tagging
        async function selectAthleteForTag(athleteName) {
            selectedAthleteForTag = athleteName;
            document.getElementById('athleteTagSearch').value = athleteName;
            document.getElementById('athleteTagList').classList.remove('active');

            // Show athlete info section
            document.getElementById('athleteTagInfo').style.display = 'block';
            document.getElementById('selectedAthleteName').textContent = athleteName;

            // Reload organizations to get latest data (in case new orgs were created)
            await loadAllOrganizations();

            // Repopulate the organization dropdown with latest data
            const orgTagSelect = document.getElementById('orgTagSelect');
            const currentSelection = orgTagSelect.value; // Save current selection
            orgTagSelect.innerHTML = '<option value="">-- No Organization --</option>';

            const orgIds = Object.keys(allOrganizations).sort((a, b) => {
                return allOrganizations[a].name.localeCompare(allOrganizations[b].name);
            });

            orgIds.forEach(orgId => {
                const org = allOrganizations[orgId];
                const option = document.createElement('option');
                option.value = orgId;
                option.textContent = org.name;
                orgTagSelect.appendChild(option);
            });

            // Get current organization
            await loadAthleteOrganizations();
            const currentOrgId = athleteOrganizations[athleteName];

            if (currentOrgId && allOrganizations[currentOrgId]) {
                document.getElementById('currentOrgTag').textContent = allOrganizations[currentOrgId].name;
                document.getElementById('currentOrgTag').style.color = '#28a745';
                document.getElementById('orgTagSelect').value = currentOrgId;
            } else {
                document.getElementById('currentOrgTag').textContent = 'None';
                document.getElementById('currentOrgTag').style.color = '#999';
                document.getElementById('orgTagSelect').value = '';
            }
        }

        // Update athlete organization
        async function updateAthleteOrganization() {
            if (!selectedAthleteForTag) {
                alert('Please select an athlete first');
                return;
            }

            const orgId = document.getElementById('orgTagSelect').value;

            if (!orgId) {
                alert('Please select an organization');
                return;
            }

            try {
                const sanitizedName = sanitizeFirebaseKey(selectedAthleteForTag);
                await database.ref('athleteOrganizations/' + sanitizedName).set(orgId);
                athleteOrganizations[sanitizedName] = orgId;

                alert(`Successfully tagged ${selectedAthleteForTag} with ${allOrganizations[orgId].name}!`);
                selectAthleteForTag(selectedAthleteForTag); // Refresh display
                await refreshOrganizationsTable();
            } catch (error) {
                console.error('Error updating athlete organization:', error);
                alert('Failed to update athlete organization: ' + error.message);
            }
        }

        // Remove athlete organization
        async function removeAthleteOrganization() {
            if (!selectedAthleteForTag) {
                alert('Please select an athlete first');
                return;
            }

            if (!confirm(`Remove organization tag from ${selectedAthleteForTag}?`)) {
                return;
            }

            try {
                const sanitizedName = sanitizeFirebaseKey(selectedAthleteForTag);
                await database.ref('athleteOrganizations/' + sanitizedName).remove();
                delete athleteOrganizations[sanitizedName];

                alert(`Organization tag removed from ${selectedAthleteForTag}`);
                selectAthleteForTag(selectedAthleteForTag); // Refresh display
                await refreshOrganizationsTable();
            } catch (error) {
                console.error('Error removing athlete organization:', error);
                alert('Failed to remove athlete organization: ' + error.message);
            }
        }

        // Manual Athlete Entry Functions

        // Generate default access code from name (e.g., "John Smith" -> "JS2025")
        function generateAccessCode(name) {
            const nameParts = name.trim().split(/\s+/);
            let initials = '';

            if (nameParts.length >= 2) {
                // Use first and last name initials
                initials = nameParts[0][0].toUpperCase() + nameParts[nameParts.length - 1][0].toUpperCase();
            } else if (nameParts.length === 1) {
                // Use first two letters if only one name
                initials = nameParts[0].substring(0, 2).toUpperCase();
            }

            return initials + '2025';
        }

        // Clear athlete form
        function clearAthleteForm() {
            document.getElementById('newAthleteName').value = '';
            document.getElementById('newAthleteEmail').value = '';
            document.getElementById('newAthleteAccessCode').value = '';
            document.getElementById('newAthletePassword').value = '';
            document.getElementById('newAthleteOrganization').value = '';
            document.getElementById('athleteCreationStatus').textContent = '';
            document.getElementById('athleteCreationStatus').style.color = '';
        }

        // Populate organization dropdown for manual athlete entry
        function populateAthleteOrgDropdown() {
            const select = document.getElementById('newAthleteOrganization');
            if (!select) return;

            // Clear existing options except first one
            select.innerHTML = '<option value="">-- No Organization --</option>';

            // Add all organizations
            Object.keys(allOrganizations).forEach(orgId => {
                const org = allOrganizations[orgId];
                const option = document.createElement('option');
                option.value = orgId;
                option.textContent = org.name;
                select.appendChild(option);
            });
        }

        // Create manual athlete
        async function createManualAthlete() {
            const statusElement = document.getElementById('athleteCreationStatus');
            const name = document.getElementById('newAthleteName').value.trim();
            const email = document.getElementById('newAthleteEmail').value.trim();
            let accessCode = document.getElementById('newAthleteAccessCode').value.trim();
            let password = document.getElementById('newAthletePassword').value.trim();
            const orgId = document.getElementById('newAthleteOrganization').value;

            // Validation
            if (!name) {
                statusElement.textContent = 'Please enter athlete name';
                statusElement.style.color = '#dc3545';
                return;
            }

            // Check if athlete already exists
            const sanitizedName = sanitizeFirebaseKey(name);
            if (athletesList.includes(name)) {
                statusElement.textContent = 'Athlete already exists';
                statusElement.style.color = '#dc3545';
                return;
            }

            // Generate access code if not provided
            if (!accessCode) {
                accessCode = generateAccessCode(name);
            }

            // Generate password if not provided (same as access code generation)
            if (!password) {
                password = generateAccessCode(name);
            }

            // Validate password length
            if (password.length < 6) {
                statusElement.textContent = 'Password must be at least 6 characters';
                statusElement.style.color = '#dc3545';
                return;
            }

            statusElement.textContent = 'Creating athlete...';
            statusElement.style.color = '#007bff';

            try {
                // 1. Create athlete record in athletes collection
                const athleteData = {
                    name: name,
                    sanitizedName: sanitizedName,
                    email: email || '',
                    createdAt: new Date().toISOString(),
                    createdFrom: 'manual',
                    asanaProjectId: '',
                    hasAccessCode: true,
                    accessCode: accessCode,
                    totalSales: 0,
                    organization: orgId || null
                };

                await database.ref('athletes/' + sanitizedName).set(athleteData);

                // 2. Add access code to accessCodes collection
                await database.ref('accessCodes/' + sanitizedName).set(accessCode);

                // 3. Add name mapping for sanitization
                await database.ref('nameMapping/' + sanitizedName).set(name);

                // 4. Set custom password if different from default
                const defaultPassword = generateAccessCode(name);
                if (password !== defaultPassword) {
                    await database.ref('customPasswords/' + sanitizedName).set(password);
                }

                // 5. Add organization mapping if selected
                if (orgId) {
                    await database.ref('athleteOrganizations/' + sanitizedName).set(orgId);
                }

                // Update local data
                athletesList.push(name);
                athletesList.sort();
                accessCodes[name] = accessCode;

                statusElement.textContent = `âœ“ Athlete "${name}" created successfully!`;
                statusElement.style.color = '#28a745';

                // Show success details
                setTimeout(() => {
                    alert(
                        `Athlete Created Successfully!\n\n` +
                        `Name: ${name}\n` +
                        `Access Code: ${accessCode}\n` +
                        `Password: ${password}\n` +
                        `Email: ${email || 'Not provided'}\n` +
                        `Organization: ${orgId ? allOrganizations[orgId].name : 'None'}\n\n` +
                        `The athlete can now log in using their name and password.`
                    );
                }, 500);

                // Clear form after 3 seconds
                setTimeout(() => {
                    clearAthleteForm();
                }, 3000);

                // Refresh user list if visible
                if (document.getElementById('allUsersTableBody')) {
                    refreshUserStatusTable();
                }

            } catch (error) {
                console.error('Error creating athlete:', error);
                statusElement.textContent = 'Error: ' + error.message;
                statusElement.style.color = '#dc3545';
                alert('Failed to create athlete: ' + error.message);
            }
        }

        // Switch login type (athlete or organization)
        function switchLoginType(type) {
            currentLoginType = type;

            const athleteLoginBtn = document.getElementById('athleteLoginBtn');
            const orgLoginBtn = document.getElementById('orgLoginBtn');
            const athleteLoginForm = document.getElementById('athleteLoginForm');
            const organizationLoginForm = document.getElementById('organizationLoginForm');

            if (type === 'athlete') {
                athleteLoginBtn.style.background = 'linear-gradient(135deg, #8a2be2 0%, #0b1215 100%)';
                orgLoginBtn.style.background = '#6c757d';
                athleteLoginForm.style.display = 'block';
                organizationLoginForm.style.display = 'none';
            } else {
                athleteLoginBtn.style.background = '#6c757d';
                orgLoginBtn.style.background = 'linear-gradient(135deg, #8a2be2 0%, #0b1215 100%)';
                athleteLoginForm.style.display = 'none';
                organizationLoginForm.style.display = 'block';
            }
        }

        // Login as organization
        async function loginAsOrganization() {
            const orgId = document.getElementById('orgSelect').value;
            const password = document.getElementById('orgPassword').value;

            if (!orgId) {
                alert('Please select an organization');
                return;
            }

            if (!password) {
                alert('Please enter a password');
                return;
            }

            await loadAllOrganizations();
            const org = allOrganizations[orgId];

            if (!org) {
                alert('Organization not found');
                return;
            }

            // Use organization ID as basis for synthetic email
            const syntheticEmail = `org_${orgId.toLowerCase().replace(/[^a-z0-9]/g, '_')}@iconportal.internal`;

            try {
                // Try to sign in first (most common case)
                let userCredential;
                let isNewAccount = false;

                try {
                    console.log('Attempting to sign in organization with Firebase Auth');
                    userCredential = await auth.signInWithEmailAndPassword(syntheticEmail, password);
                    console.log('âœ… Organization logged in successfully with existing Firebase Auth account');
                } catch (signInError) {
                    // Firebase returns auth/invalid-credential or auth/user-not-found when account doesn't exist
                    if (signInError.code === 'auth/user-not-found' || signInError.code === 'auth/invalid-credential') {
                        // Account might not exist - try to create it (lazy migration)
                        console.log(`Account not found for organization ${orgId} - attempting to create account`);

                        // Verify password matches stored password
                        if (password !== org.password) {
                            alert('Invalid password');
                            return;
                        }

                        // Create Firebase Auth account
                        try {
                            // Hide login section and show creating account message
                            document.getElementById('loginSection').style.display = 'none';
                            showLoading(true, 'Creating Account...', 'Setting up your organization account, please wait...');

                            userCredential = await auth.createUserWithEmailAndPassword(syntheticEmail, password);
                            isNewAccount = true;
                            console.log('âœ… Organization Firebase Auth account created');

                            // Wait for account and auth token to fully propagate
                            // Firebase Auth tokens can take 2-4 seconds to sync with Realtime Database
                            console.log('Waiting for Firebase Auth token to propagate...');
                            await new Promise(resolve => setTimeout(resolve, 4000));
                        } catch (createError) {
                            // Hide loading and show login again on error
                            showLoading(false);
                            document.getElementById('loginSection').style.display = 'block';

                            if (createError.code === 'auth/email-already-in-use') {
                                // Account exists but password is wrong
                                console.error('Organization account exists with different password');
                                alert('Invalid password. The account exists with a different password.\n\nContact your administrator to reset your password.');
                                return;
                            }
                            throw createError;
                        }
                    } else if (signInError.code === 'auth/wrong-password') {
                        // Wrong password
                        alert('Invalid password');
                        return;
                    } else {
                        // Other sign-in error
                        throw signInError;
                    }
                }

                const user = userCredential.user;

                // Get or set role
                let roleData = await getUserRole(user.uid);

                if (!roleData) {
                    // New account - set role in database with retry logic
                    // Retry setting role if it fails (common on first login due to token propagation)
                    // This is non-blocking - if it fails, we still let the user proceed
                    for (let attempt = 1; attempt <= 5; attempt++) {
                        try {
                            console.log(`Setting organization role in database (attempt ${attempt})...`);
                            await setUserRoleInDatabase(user.uid, 'organization', null, orgId);
                            console.log('âœ… Organization role set successfully');
                            break;
                        } catch (roleError) {
                            console.error(`Attempt ${attempt} to set role failed:`, roleError);
                            if (attempt < 5) {
                                console.log('Retrying in 1.5 seconds...');
                                await new Promise(resolve => setTimeout(resolve, 1500));
                            } else {
                                console.warn('âš ï¸ Failed to set organization role after 5 attempts. Role will be set on next login.');
                                // Don't throw - allow user to proceed anyway
                            }
                        }
                    }
                }

                // Store current user state
                currentUser = user;
                currentRole = 'organization';
                currentOrganization = orgId;
                currentAthlete = null;
                window.currentAccessCode = null;
                window.currentOrgName = orgId;

                await showOrganizationDashboard(orgId);

            } catch (error) {
                console.error('Organization login error:', error);

                // Hide loading and show login section again on error
                showLoading(false);
                document.getElementById('loginSection').style.display = 'block';

                if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    alert('Invalid password. Please try again.\n\nIf this is your first login and you keep getting this error, the account may have been created with a different password during testing. Contact your administrator to reset your account.');
                } else if (error.code === 'auth/too-many-requests') {
                    alert('Too many failed login attempts. Please try again later or contact your administrator.');
                } else if (error.code === 'auth/email-already-in-use') {
                    alert('Account setup error. Please try logging in again.');
                } else {
                    alert('Login failed. Please try again.\n\nError: ' + (error.message || 'Unknown error'));
                }
            }
        }

        // Show organization dashboard
        async function showOrganizationDashboard(orgId) {
            // Load all portal data now that user is authenticated
            try {
                showLoading(true);
                await loadPortalData();
                showLoading(false);
            } catch (error) {
                console.error('Error loading portal data:', error);
                alert('Failed to load dashboard data. Please refresh the page.');
                showLoading(false);
                return;
            }

            const org = allOrganizations[orgId];

            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

            // Hide password change button for organization logins
            const passwordBtn = document.querySelector('.change-password-btn');
            if (passwordBtn) passwordBtn.style.display = 'none';

            document.getElementById('athleteName').textContent = org.name + ' (Organization)';

            // Get tagged athletes (athleteOrganizations now uses original names as keys)
            const taggedAthletes = Object.keys(athleteOrganizations).filter(athleteName => {
                return athleteOrganizations[athleteName] === orgId;
            });

            // Aggregate data for all tagged athletes
            let totalRoyalties = 0;
            let totalOrders = 0;
            let gameJerseys = 0;
            let otherItems = 0;
            let jersey20Count = 0;
            const monthlyData = {};
            const organizationData = [];

            taggedAthletes.forEach(athleteName => {
                const athleteSales = athleteData[athleteName] || [];
                athleteSales.forEach(row => {
                    organizationData.push({ ...row, athlete_name: athleteName });

                    const royalty = calculateRoyalty(row);
                    totalRoyalties += royalty;
                    totalOrders++;

                    const isGameJersey = normalizeBoolean(row.is_game_jersey);

                    if (isGameJersey) {
                        gameJerseys++;
                    } else {
                        otherItems++;
                    }

                    const hasJersey20 = normalizeBoolean(row.has_jersey20);

                    if (hasJersey20) {
                        jersey20Count++;
                    }

                    const month = row.month_year || '2024-01';
                    monthlyData[month] = (monthlyData[month] || 0) + royalty;
                });
            });

            // Calculate organization earnings
            const signupBonus = org.referralPerSale || 0;
            const bonusPercentage = org.bonusPercentage || 0;
            const signupEarnings = taggedAthletes.length * signupBonus; // One-time per athlete
            const bonusEarnings = totalRoyalties * (bonusPercentage / 100);
            const totalOrgEarnings = signupEarnings + bonusEarnings;

            // Update stats - show organization earnings plus athlete royalties
            document.getElementById('totalRoyalties').innerHTML = `
                <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Athlete Royalties</div>
                <div style="font-size: 1.5em; color: #8a2be2;">$${Math.round(totalRoyalties)}</div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #e0e0e0;">
                    <div style="font-size: 0.9em; color: #666;">Organization Earnings</div>
                    <div style="font-size: 1.3em; color: #28a745; font-weight: bold;">$${Math.round(totalOrgEarnings)}</div>
                    <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        Signup Bonuses: $${Math.round(signupEarnings)} (${taggedAthletes.length} athletes) | Sales Bonus: $${Math.round(bonusEarnings)}
                    </div>
                </div>
            `;
            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('gameJerseys').textContent = gameJerseys;
            document.getElementById('otherItems').textContent = otherItems;

            if (jersey20Count > 0) {
                document.getElementById('jersey20Alert').style.display = 'block';
                document.getElementById('jersey20Count').textContent = jersey20Count;
            } else {
                document.getElementById('jersey20Alert').style.display = 'none';
            }

            // Render monthly chart
            const chartDiv = document.getElementById('monthChart');
            chartDiv.innerHTML = '';

            // Get last 12 months for rolling window
            const last12Months = getLast12Months();

            // Fill in monthly data for last 12 months (missing months = $0)
            const chartData = {};
            last12Months.forEach(month => {
                chartData[month] = monthlyData[month] || 0;
            });

            const values = Object.values(chartData);
            const maxValue = Math.max(...values, 1);

            if (values.some(v => v > 0)) {
                last12Months.forEach(month => {
                    const value = chartData[month];
                    const height = (value / maxValue) * 250;

                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    bar.style.height = `${Math.max(height, 20)}px`;
                    bar.innerHTML = `
                        <div class="bar-value">$${Math.round(value)}</div>
                        <div class="bar-label">${month}</div>
                    `;
                    chartDiv.appendChild(bar);
                });
            } else {
                chartDiv.innerHTML = '<p style="text-align: center; color: #999;">No monthly data available</p>';
            }

            // Render order table with pagination
            window.tableData = organizationData.slice().sort((a, b) => {
                const dateA = a.created_at ? new Date(a.created_at) : new Date(0);
                const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
                return dateB - dateA;
            });

            // Use the pagination-aware renderTable function
            renderTable(window.tableData, true);

            // Show tagged athletes panel for organization
            await populateTaggedAthletesTable(taggedAthletes);
            document.getElementById('taggedAthletesPanel').style.display = 'block';

            // Load organization referrals (referrals content is now in the rewards panel)
            loadOrganizationReferrals(orgId);

            // Hide admin tools
            document.getElementById('adminToolsPanel').style.display = 'none';
        }

        // Populate the tagged athletes table with sales stats and notes
        async function populateTaggedAthletesTable(taggedAthletes) {
            // Load athlete notes
            await loadAllAthleteNotes();

            const tbody = document.getElementById('taggedAthletesTable');
            const countSpan = document.getElementById('taggedAthletesCount');

            countSpan.textContent = taggedAthletes.length;

            if (taggedAthletes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">No athletes tagged with this organization</td></tr>';
                return;
            }

            // Build table rows
            let tableHTML = '';
            taggedAthletes.forEach(athleteName => {
                const athleteSales = athleteData[athleteName] || [];
                let totalRoyalties = 0;

                athleteSales.forEach(row => {
                    totalRoyalties += calculateRoyalty(row);
                });

                // Get notes for this athlete
                const sanitizedName = sanitizeFirebaseKey(athleteName);
                const notes = athleteNotes[sanitizedName] || '';
                const notesDisplay = notes
                    ? `<div style="max-width: 300px; white-space: pre-wrap; word-wrap: break-word;">${notes}</div>`
                    : '<em style="color: #999;">No notes</em>';

                tableHTML += `
                    <tr>
                        <td style="font-weight: 600;">${athleteName}</td>
                        <td style="text-align: center;">${athleteSales.length}</td>
                        <td style="text-align: center; color: #8a2be2; font-weight: 600;">$${Math.round(totalRoyalties)}</td>
                        <td style="font-size: 0.9em; color: #666;">${notesDisplay}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = tableHTML;
        }

        // Modal close functions
        function closeEditOrganizationModal() {
            document.getElementById('editOrganizationModal').style.display = 'none';
        }

        function closeViewOrgAthletesModal() {
            document.getElementById('viewOrgAthletesModal').style.display = 'none';
        }

        // ========== END ORGANIZATION MANAGEMENT FUNCTIONS ==========

        // Toggle Order History Collapsible
        function toggleOrderHistory() {
            const content = document.getElementById('orderHistoryContent');
            const icon = document.getElementById('orderHistoryIcon');

            content.classList.toggle('open');
            icon.classList.toggle('open');
        }

        // Toggle Admin Tools Collapsible
        function toggleAdminTools() {
            const content = document.getElementById('adminToolsContent');
            const icon = document.getElementById('adminToolsIcon');

            content.classList.toggle('open');
            icon.classList.toggle('open');
        }

        // Toggle Tagged Athletes Collapsible
        function toggleTaggedAthletes() {
            const content = document.getElementById('taggedAthletesContent');
            const icon = document.getElementById('taggedAthletesIcon');

            content.classList.toggle('open');
            icon.classList.toggle('open');
        }

        // ========== REFERRAL SYSTEM FUNCTIONS ==========

        // ========== GAMIFIED REFERRAL REWARDS FUNCTIONS ==========

        // Zapier Webhook URL for redemption notifications
        const ZAPIER_WEBHOOK_URL = 'https://hooks.zapier.com/hooks/catch/15450294/uar3ozo/';

        // Store current rewards data for the logged-in user
        let currentUserRewards = {
            gemsEarned: 0,
            gemsSpent: 0,
            redemptions: []
        };

        // Load rewards data from Firebase
        async function loadUserRewards(userName) {
            try {
                const sanitizedName = sanitizeFirebaseKey(userName);
                const rewardsRef = firebase.database().ref('athletes/' + sanitizedName + '/rewards');
                const snapshot = await rewardsRef.once('value');

                if (snapshot.exists()) {
                    currentUserRewards = snapshot.val();
                    // Ensure redemptions is an array
                    if (!Array.isArray(currentUserRewards.redemptions)) {
                        currentUserRewards.redemptions = currentUserRewards.redemptions ? Object.values(currentUserRewards.redemptions) : [];
                    }
                } else {
                    currentUserRewards = { gemsEarned: 0, gemsSpent: 0, redemptions: [] };
                }

                return currentUserRewards;
            } catch (error) {
                console.error('Error loading rewards:', error);
                return { gemsEarned: 0, gemsSpent: 0, redemptions: [] };
            }
        }

        // Save rewards data to Firebase
        async function saveUserRewards(userName, rewardsData) {
            try {
                const sanitizedName = sanitizeFirebaseKey(userName);
                await firebase.database().ref('athletes/' + sanitizedName + '/rewards').set(rewardsData);
                console.log('Rewards saved to Firebase');
                return true;
            } catch (error) {
                console.error('Error saving rewards:', error);
                return false;
            }
        }

        // Update the rewards journey UI based on referral data
        async function updateRewardsJourneyUI(referrals) {
            const totalReferrals = referrals.length;
            const successfulReferrals = referrals.filter(ref => ref.status === 'success').length;
            const pendingReferrals = totalReferrals - successfulReferrals;

            // Load rewards data (for gems spent/redemptions)
            const userName = window.currentAccessCode || window.currentOrgName;
            if (userName) {
                await loadUserRewards(userName);
            }

            // Calculate available gems (earned - spent)
            const gemsEarned = successfulReferrals;
            const gemsSpent = currentUserRewards.gemsSpent || 0;
            const availableGems = gemsEarned - gemsSpent;

            // Update rewards data in memory
            currentUserRewards.gemsEarned = gemsEarned;

            // Update Clutch Gems count display (show available gems)
            document.getElementById('clutchGemsCount').textContent = availableGems;

            // Update stats display
            document.getElementById('totalReferralsCount').textContent = totalReferrals;
            document.getElementById('successfulReferralsCount').textContent = successfulReferrals;
            document.getElementById('pendingReferralsCount').textContent = pendingReferrals;

            // Calculate progress percentage based on total earned (max at 5 gems = 100%)
            const maxGems = 5;
            const progressPercent = Math.min((gemsEarned / maxGems) * 100, 100);

            // Animate progress bar after a short delay
            setTimeout(() => {
                document.getElementById('rewardsProgressFill').style.width = progressPercent + '%';
            }, 300);

            // Update milestones based on total earned
            updateMilestone('milestone0', gemsEarned >= 0, gemsEarned === 0);
            updateMilestone('milestone2', gemsEarned >= 2, gemsEarned >= 1 && gemsEarned < 2);
            updateMilestone('milestone3', gemsEarned >= 3, gemsEarned >= 2 && gemsEarned < 3);
            updateMilestone('milestone5', gemsEarned >= 5, gemsEarned >= 3 && gemsEarned < 5);

            // Update reward cards based on available gems and redemption status
            updateRewardCardWithRedemption('rewardCard2', 'shirt', 2, availableGems);
            updateRewardCardWithRedemption('rewardCard3', 'any_item', 3, availableGems);
            updateRewardCardWithRedemption('rewardCard5', 'hoodie_or_jersey', 5, availableGems);

            // Update cash earned display (based on available gems)
            const cashEarnedDisplay = document.getElementById('cashEarnedDisplay');
            if (availableGems > 0) {
                const cashValue = availableGems * 5;
                cashEarnedDisplay.textContent = `(Worth $${cashValue} in cash!)`;
                cashEarnedDisplay.style.display = 'inline';
            } else {
                cashEarnedDisplay.style.display = 'none';
            }
        }

        // Check if a reward has been redeemed
        function isRewardRedeemed(rewardType) {
            if (!currentUserRewards.redemptions) return false;
            return currentUserRewards.redemptions.some(r => r.rewardType === rewardType);
        }

        // Update reward card with redemption status
        function updateRewardCardWithRedemption(cardId, rewardType, gemCost, availableGems) {
            const card = document.getElementById(cardId);
            if (!card) return;

            card.classList.remove('locked', 'unlocked', 'redeemed');

            if (isRewardRedeemed(rewardType)) {
                card.classList.add('redeemed');
            } else if (availableGems >= gemCost) {
                card.classList.add('unlocked');
            } else {
                card.classList.add('locked');
            }
        }

        // Redeem a reward
        async function redeemReward(rewardType, gemCost) {
            const userName = window.currentAccessCode || window.currentOrgName;
            if (!userName) {
                alert('Error: No user logged in');
                return;
            }

            // Check if already redeemed
            if (isRewardRedeemed(rewardType)) {
                alert('You have already redeemed this reward!');
                return;
            }

            // Check if enough gems
            const availableGems = currentUserRewards.gemsEarned - (currentUserRewards.gemsSpent || 0);
            if (availableGems < gemCost) {
                alert(`Not enough gems! You need ${gemCost} gems but only have ${availableGems}.`);
                return;
            }

            // Format reward name for display
            const rewardNames = {
                'shirt': 'Shirt',
                'any_item': 'Any Item (excluding hoodie/jersey)',
                'hoodie_or_jersey': 'Hoodie or Jersey'
            };
            const rewardName = rewardNames[rewardType] || rewardType;

            // Confirm redemption
            if (!confirm(`Are you sure you want to redeem "${rewardName}" for ${gemCost} gems?`)) {
                return;
            }

            // Create redemption record
            const redemption = {
                rewardType: rewardType,
                rewardName: rewardName,
                gemCost: gemCost,
                redeemedAt: new Date().toISOString(),
                status: 'pending'
            };

            // Update rewards data
            currentUserRewards.gemsSpent = (currentUserRewards.gemsSpent || 0) + gemCost;
            if (!currentUserRewards.redemptions) {
                currentUserRewards.redemptions = [];
            }
            currentUserRewards.redemptions.push(redemption);

            // Save to Firebase
            const saved = await saveUserRewards(userName, currentUserRewards);
            if (!saved) {
                alert('Error saving redemption. Please try again.');
                // Revert changes
                currentUserRewards.gemsSpent -= gemCost;
                currentUserRewards.redemptions.pop();
                return;
            }

            // Send email notification
            await sendRedemptionEmail(userName, rewardName, gemCost);

            // Update UI
            const referralsRef = firebase.database().ref('athletes/' + sanitizeFirebaseKey(userName) + '/referrals');
            const snapshot = await referralsRef.once('value');
            const referrals = [];
            snapshot.forEach(child => {
                referrals.push(child.val());
            });
            await updateRewardsJourneyUI(referrals);

            alert(`ðŸŽ‰ Congratulations! Your "${rewardName}" redemption request has been submitted. We'll be in touch soon!`);
        }

        // Send redemption notification via Zapier webhook
        async function sendRedemptionEmail(userName, rewardName, gemCost) {
            try {
                if (ZAPIER_WEBHOOK_URL === 'YOUR_ZAPIER_WEBHOOK_URL') {
                    console.log('Zapier webhook not configured - redemption stored in Firebase');
                    return;
                }

                const payload = {
                    athlete_name: userName,
                    reward_name: rewardName,
                    gem_cost: gemCost,
                    redemption_date: new Date().toLocaleString(),
                    remaining_gems: currentUserRewards.gemsEarned - currentUserRewards.gemsSpent
                };

                await fetch(ZAPIER_WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log('Redemption webhook sent successfully');
            } catch (error) {
                console.error('Error sending webhook:', error);
                // Webhook failed but redemption is still saved in Firebase
            }
        }

        // Update milestone appearance
        function updateMilestone(milestoneId, isAchieved, isCurrent) {
            const milestone = document.getElementById(milestoneId);
            if (!milestone) return;

            milestone.classList.remove('achieved', 'current');

            if (isAchieved) {
                milestone.classList.add('achieved');
            } else if (isCurrent) {
                milestone.classList.add('current');
            }
        }

        // Show the rewards journey panel
        function showRewardsJourneyPanel() {
            const rewardsPanel = document.getElementById('rewardsJourneyPanel');
            if (rewardsPanel) {
                rewardsPanel.style.display = 'block';
            }
        }

        // Hide the rewards journey panel
        function hideRewardsJourneyPanel() {
            const rewardsPanel = document.getElementById('rewardsJourneyPanel');
            if (rewardsPanel) {
                rewardsPanel.style.display = 'none';
            }
        }

        // Generate referral link
        function generateReferralLink() {
            const name = document.getElementById('referralName').value.trim();
            const instagram = document.getElementById('referralInstagram').value.trim();

            if (!name) {
                alert('Please enter your friend\'s name');
                return;
            }

            // Get referrer info (athlete code or org name)
            const referrerCode = window.currentAccessCode || window.currentOrgName;
            if (!referrerCode) {
                alert('Unable to generate referral link. Please try logging in again.');
                return;
            }

            // Create referral object
            const referralData = {
                referrerCode: referrerCode,
                referrerType: window.currentAccessCode ? 'athlete' : 'organization',
                friendName: name,
                friendInstagram: instagram,
                dateReferred: new Date().toISOString(),
                status: 'pending'
            };

            // Save to Firebase
            const referralsRef = window.currentAccessCode
                ? firebase.database().ref('athletes/' + sanitizeFirebaseKey(window.currentAccessCode) + '/referrals')
                : firebase.database().ref('organizations/' + sanitizeFirebaseKey(window.currentOrgName) + '/referrals');

            const newReferralRef = referralsRef.push();
            newReferralRef.set(referralData).then(() => {
                // Generate JotForm link with prefilled parameter
                const jotFormUrl = `https://form.jotform.com/252567263198164?referral=${encodeURIComponent(referrerCode)}`;

                // Display the link
                document.getElementById('generatedLink').value = jotFormUrl;
                document.getElementById('generatedLinkContainer').style.display = 'block';

                // Clear form
                document.getElementById('referralName').value = '';
                document.getElementById('referralInstagram').value = '';

                // Reload referrals list
                if (window.currentAccessCode) {
                    loadUserReferrals(window.currentAccessCode);
                } else {
                    loadOrganizationReferrals(window.currentOrgName);
                }

                // Show follow-up message
                showFollowUpMessage(name);
            }).catch((error) => {
                console.error('Error saving referral:', error);
                alert('Error generating referral link. Please try again.');
            });
        }

        // Copy referral link to clipboard
        function copyReferralLink() {
            const linkInput = document.getElementById('generatedLink');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // For mobile devices

            try {
                document.execCommand('copy');
                const feedback = document.getElementById('copyFeedback');
                feedback.style.display = 'block';
                setTimeout(() => {
                    feedback.style.display = 'none';
                }, 3000);
            } catch (err) {
                console.error('Failed to copy:', err);
                alert('Failed to copy link. Please copy it manually.');
            }
        }

        // Show follow-up message
        function showFollowUpMessage(friendName) {
            alert(`Great! Share this link with ${friendName}. When they sign up using your link, you'll both earn rewards!`);
        }

        // Load user referrals (for athletes)
        function loadUserReferrals(accessCode) {
            const referralsRef = firebase.database().ref('athletes/' + sanitizeFirebaseKey(accessCode) + '/referrals');

            referralsRef.once('value').then((snapshot) => {
                const referrals = [];
                snapshot.forEach((childSnapshot) => {
                    const referral = childSnapshot.val();
                    referral.id = childSnapshot.key;
                    referrals.push(referral);
                });

                // Sort by date (newest first)
                referrals.sort((a, b) => new Date(b.dateReferred) - new Date(a.dateReferred));

                // Update gamified rewards journey UI
                showRewardsJourneyPanel();
                updateRewardsJourneyUI(referrals);

                // Display referrals
                const tbody = document.getElementById('referralsTableBody');
                if (referrals.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">No referrals yet</td></tr>';
                } else {
                    tbody.innerHTML = referrals.map(ref => {
                        const date = new Date(ref.dateReferred).toLocaleDateString();
                        const statusBadge = ref.status === 'success'
                            ? '<span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">Success</span>'
                            : '<span style="background: #ff9800; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">Pending</span>';

                        return `
                            <tr>
                                <td>${ref.friendName}</td>
                                <td>${ref.friendInstagram || '-'}</td>
                                <td>${date}</td>
                                <td>${statusBadge}</td>
                            </tr>
                        `;
                    }).join('');
                }
            }).catch((error) => {
                console.error('Error loading referrals:', error);
            });
        }

        // Load organization referrals
        function loadOrganizationReferrals(orgName) {
            const referralsRef = firebase.database().ref('organizations/' + sanitizeFirebaseKey(orgName) + '/referrals');

            referralsRef.once('value').then((snapshot) => {
                const referrals = [];
                snapshot.forEach((childSnapshot) => {
                    const referral = childSnapshot.val();
                    referral.id = childSnapshot.key;
                    referrals.push(referral);
                });

                // Sort by date (newest first)
                referrals.sort((a, b) => new Date(b.dateReferred) - new Date(a.dateReferred));

                // Update gamified rewards journey UI
                showRewardsJourneyPanel();
                updateRewardsJourneyUI(referrals);

                // Display referrals
                const tbody = document.getElementById('referralsTableBody');
                if (referrals.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">No referrals yet</td></tr>';
                } else {
                    tbody.innerHTML = referrals.map(ref => {
                        const date = new Date(ref.dateReferred).toLocaleDateString();
                        const statusBadge = ref.status === 'success'
                            ? '<span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">Success</span>'
                            : '<span style="background: #ff9800; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">Pending</span>';

                        return `
                            <tr>
                                <td>${ref.friendName}</td>
                                <td>${ref.friendInstagram || '-'}</td>
                                <td>${date}</td>
                                <td>${statusBadge}</td>
                            </tr>
                        `;
                    }).join('');
                }
            }).catch((error) => {
                console.error('Error loading referrals:', error);
            });
        }

        // ========== ADMIN REFERRAL MANAGEMENT FUNCTIONS ==========

        let allReferralsData = [];
        let currentReferralFilter = 'all';

        // Load all referrals (admin only)
        function loadAllReferrals() {
            const athletesRef = firebase.database().ref('athletes');
            const orgsRef = firebase.database().ref('organizations');

            allReferralsData = [];

            // Load athlete referrals
            athletesRef.once('value').then((snapshot) => {
                snapshot.forEach((athleteSnapshot) => {
                    const athleteCode = athleteSnapshot.key;
                    const referrals = athleteSnapshot.val().referrals;

                    if (referrals) {
                        Object.keys(referrals).forEach(refId => {
                            const ref = referrals[refId];
                            allReferralsData.push({
                                id: refId,
                                referrerCode: athleteCode,
                                referrerType: 'athlete',
                                ...ref
                            });
                        });
                    }
                });

                // Load organization referrals
                return orgsRef.once('value');
            }).then((snapshot) => {
                snapshot.forEach((orgSnapshot) => {
                    const orgName = orgSnapshot.key;
                    const referrals = orgSnapshot.val().referrals;

                    if (referrals) {
                        Object.keys(referrals).forEach(refId => {
                            const ref = referrals[refId];
                            allReferralsData.push({
                                id: refId,
                                referrerCode: orgName,
                                referrerType: 'organization',
                                ...ref
                            });
                        });
                    }
                });

                // Sort by date (newest first)
                allReferralsData.sort((a, b) => new Date(b.dateReferred) - new Date(a.dateReferred));

                // Display referrals
                displayAdminReferrals();
            }).catch((error) => {
                console.error('Error loading all referrals:', error);
            });
        }

        // Display admin referrals table
        function displayAdminReferrals() {
            const filteredReferrals = currentReferralFilter === 'all'
                ? allReferralsData
                : allReferralsData.filter(ref => ref.status === currentReferralFilter);

            const tbody = document.getElementById('adminReferralsTable');
            if (filteredReferrals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No referrals found</td></tr>';
            } else {
                tbody.innerHTML = filteredReferrals.map(ref => {
                    const date = new Date(ref.dateReferred).toLocaleDateString();
                    const statusBadge = ref.status === 'success'
                        ? '<span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">Success</span>'
                        : '<span style="background: #ff9800; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">Pending</span>';

                    return `
                        <tr onclick="selectReferralForUpdate('${ref.id}', '${ref.referrerCode}', '${ref.referrerType}')" style="cursor: pointer;">
                            <td>${ref.referrerCode} (${ref.referrerType})</td>
                            <td>${ref.friendName}</td>
                            <td>${ref.friendInstagram || '-'}</td>
                            <td>${date}</td>
                            <td>${statusBadge}</td>
                            <td><button class="btn" style="padding: 5px 10px; font-size: 12px;">Select</button></td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // Filter referrals
        function filterReferrals(status) {
            currentReferralFilter = status;

            // Update button styles
            document.getElementById('filterAllReferrals').style.background = status === 'all' ? '#333' : '#666';
            document.getElementById('filterPendingReferrals').style.background = status === 'pending' ? '#333' : '#666';
            document.getElementById('filterSuccessReferrals').style.background = status === 'success' ? '#333' : '#666';

            displayAdminReferrals();
        }

        // Search referrals by referee name or Instagram
        function searchReferrals(query) {
            const searchTerm = query.toLowerCase().trim();
            const tbody = document.getElementById('adminReferralsTable');

            if (!searchTerm) {
                // If search is empty, show all referrals with current filter
                displayAdminReferrals();
                return;
            }

            // Filter based on search term
            const filteredByStatus = currentReferralFilter === 'all'
                ? allReferralsData
                : allReferralsData.filter(ref => ref.status === currentReferralFilter);

            const searchResults = filteredByStatus.filter(ref => {
                const friendName = (ref.friendName || '').toLowerCase();
                const instagram = (ref.friendInstagram || '').toLowerCase();
                const referrerCode = (ref.referrerCode || '').toLowerCase();

                return friendName.includes(searchTerm) ||
                       instagram.includes(searchTerm) ||
                       referrerCode.includes(searchTerm);
            });

            // Display search results
            if (searchResults.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No referrals found matching your search</td></tr>';
            } else {
                tbody.innerHTML = searchResults.map(ref => {
                    const date = new Date(ref.dateReferred).toLocaleDateString();
                    const statusBadge = ref.status === 'success'
                        ? '<span style="background: #4caf50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">Success</span>'
                        : '<span style="background: #ff9800; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500;">Pending</span>';

                    return `
                        <tr onclick="selectReferralForUpdate('${ref.id}', '${ref.referrerCode}', '${ref.referrerType}')" style="cursor: pointer;">
                            <td>${ref.referrerCode} (${ref.referrerType})</td>
                            <td>${ref.friendName}</td>
                            <td>${ref.friendInstagram || '-'}</td>
                            <td>${date}</td>
                            <td>${statusBadge}</td>
                            <td><button class="btn" style="padding: 5px 10px; font-size: 12px;">Select</button></td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // Select referral for update
        let selectedReferralId = null;
        let selectedReferrerCode = null;
        let selectedReferrerType = null;

        function selectReferralForUpdate(refId, referrerCode, referrerType) {
            selectedReferralId = refId;
            selectedReferrerCode = referrerCode;
            selectedReferrerType = referrerType;

            // Show which referral is selected
            const infoDiv = document.getElementById('selectedReferralInfo');
            infoDiv.style.display = 'block';
            infoDiv.innerHTML = `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                    <p style="margin: 0 0 10px 0; font-weight: 500;">Selected: ${referrerCode} (${referrerType})</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="markReferralAsSuccess()">Mark as Success</button>
                        <button class="btn" onclick="markReferralAsPending()">Mark as Pending</button>
                        <button class="btn" onclick="deleteReferral()" style="background: #d32f2f;">Delete</button>
                        <button class="btn" onclick="clearReferralSelection()" style="background: #999;">Clear Selection</button>
                    </div>
                </div>
            `;
        }

        function clearReferralSelection() {
            selectedReferralId = null;
            selectedReferrerCode = null;
            selectedReferrerType = null;
            const infoDiv = document.getElementById('selectedReferralInfo');
            infoDiv.style.display = 'none';
            infoDiv.innerHTML = '';
        }

        // Mark referral as success (manual admin approval)
        function markReferralAsSuccess() {
            if (!selectedReferralId) {
                alert('Please select a referral first');
                return;
            }

            const sanitizedCode = sanitizeFirebaseKey(selectedReferrerCode);
            const refPath = selectedReferrerType === 'athlete'
                ? `athletes/${sanitizedCode}/referrals/${selectedReferralId}`
                : `organizations/${sanitizedCode}/referrals/${selectedReferralId}`;

            firebase.database().ref(refPath).update({ status: 'success' }).then(() => {
                alert('Referral marked as success!');

                // Reload data
                loadAllReferrals();
                clearReferralSelection();
            }).catch((error) => {
                console.error('Error updating referral:', error);
                alert('Error updating referral. Please try again.');
            });
        }

        // Mark referral as pending
        function markReferralAsPending() {
            if (!selectedReferralId) {
                alert('Please select a referral first');
                return;
            }

            const sanitizedCode = sanitizeFirebaseKey(selectedReferrerCode);
            const refPath = selectedReferrerType === 'athlete'
                ? `athletes/${sanitizedCode}/referrals/${selectedReferralId}`
                : `organizations/${sanitizedCode}/referrals/${selectedReferralId}`;

            firebase.database().ref(refPath).update({ status: 'pending' }).then(() => {
                alert('Referral marked as pending');
                loadAllReferrals();
                clearReferralSelection();
            }).catch((error) => {
                console.error('Error updating referral:', error);
                alert('Error updating referral. Please try again.');
            });
        }

        // Delete referral
        function deleteReferral() {
            if (!selectedReferralId) {
                alert('Please select a referral first');
                return;
            }

            // Get the referral details for confirmation
            const referral = allReferralsData.find(ref =>
                ref.id === selectedReferralId &&
                ref.referrerCode === selectedReferrerCode &&
                ref.referrerType === selectedReferrerType
            );

            if (!referral) {
                alert('Referral not found');
                return;
            }

            // Confirm deletion
            const confirmMessage = `Are you sure you want to delete this referral?\n\nReferrer: ${selectedReferrerCode} (${selectedReferrerType})\nFriend: ${referral.friendName}\nStatus: ${referral.status}`;
            if (!confirm(confirmMessage)) {
                return;
            }

            const sanitizedCode = sanitizeFirebaseKey(selectedReferrerCode);
            const refPath = selectedReferrerType === 'athlete'
                ? `athletes/${sanitizedCode}/referrals/${selectedReferralId}`
                : `organizations/${sanitizedCode}/referrals/${selectedReferralId}`;

            firebase.database().ref(refPath).remove().then(() => {
                alert('Referral deleted successfully!');
                loadAllReferrals();
                clearReferralSelection();
            }).catch((error) => {
                console.error('Error deleting referral:', error);
                alert('Error deleting referral. Please try again.');
            });
        }

        // Auto-match new signups with pending referrals
        // This should be called by your Zap after adding a new athlete to Firebase
        async function processNewSignup(newAthleteName, referralCode) {
            if (!referralCode || !newAthleteName) {
                console.log('No referral code or athlete name provided');
                return;
            }

            console.log(`Processing signup: ${newAthleteName} via referral: ${referralCode}`);

            // Normalize the name for matching (trim, lowercase)
            const normalizedSignupName = newAthleteName.trim().toLowerCase();

            // Sanitize referral code for Firebase paths (e.g., "Ava Salinas" -> "Ava_Salinas")
            const sanitizedReferralCode = sanitizeFirebaseKey(referralCode);

            // Check both athletes and organizations for the referral code
            const checkAthlete = firebase.database().ref('athletes/' + sanitizedReferralCode + '/referrals').once('value');
            const checkOrg = firebase.database().ref('organizations/' + sanitizedReferralCode + '/referrals').once('value');

            try {
                const [athleteSnapshot, orgSnapshot] = await Promise.all([checkAthlete, checkOrg]);

                let matchFound = false;
                let referrerType = null;
                let matchedReferralId = null;
                let matchedFriendName = null;

                // Check athlete referrals
                athleteSnapshot.forEach((refSnapshot) => {
                    const referral = refSnapshot.val();
                    const normalizedRefName = referral.friendName.trim().toLowerCase();

                    if (normalizedRefName === normalizedSignupName && referral.status === 'pending') {
                        matchFound = true;
                        referrerType = 'athlete';
                        matchedReferralId = refSnapshot.key;
                        matchedFriendName = referral.friendName;
                    }
                });

                // Check organization referrals if no athlete match
                if (!matchFound) {
                    orgSnapshot.forEach((refSnapshot) => {
                        const referral = refSnapshot.val();
                        const normalizedRefName = referral.friendName.trim().toLowerCase();

                        if (normalizedRefName === normalizedSignupName && referral.status === 'pending') {
                            matchFound = true;
                            referrerType = 'organization';
                            matchedReferralId = refSnapshot.key;
                            matchedFriendName = referral.friendName;
                        }
                    });
                }

                if (matchFound) {
                    // Update referral status to success
                    const refPath = referrerType === 'athlete'
                        ? `athletes/${sanitizedReferralCode}/referrals/${matchedReferralId}`
                        : `organizations/${sanitizedReferralCode}/referrals/${matchedReferralId}`;

                    await firebase.database().ref(refPath).update({
                        status: 'success',
                        matchedDate: new Date().toISOString()
                    });

                    console.log(`âœ“ Referral match found and updated! ${matchedFriendName} signed up via ${referralCode}`);

                    // Send admin notification
                    sendAdminNotification({
                        type: 'referral_match',
                        athleteName: newAthleteName,
                        referrerCode: referralCode,
                        referrerType: referrerType,
                        timestamp: new Date().toISOString()
                    });

                    return {
                        success: true,
                        message: `Referral matched: ${matchedFriendName} via ${referralCode}`
                    };
                } else {
                    console.log('No matching referral found');
                    return {
                        success: false,
                        message: 'No matching pending referral found'
                    };
                }
            } catch (error) {
                console.error('Error processing signup:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Send admin notification when referral match is found
        function sendAdminNotification(data) {
            const webhookUrl = 'YOUR_ADMIN_WEBHOOK_URL_HERE'; // Replace with your Zapier admin notification webhook

            fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: `ðŸŽ‰ Referral Match Found!`,
                    athleteName: data.athleteName,
                    referrerCode: data.referrerCode,
                    referrerType: data.referrerType,
                    timestamp: data.timestamp,
                    action: 'Review in admin dashboard'
                })
            }).catch((error) => {
                console.error('Error sending admin notification:', error);
            });
        }

        // Expose function globally for Zap to call
        window.processNewSignup = processNewSignup;

        // ========== END REFERRAL SYSTEM FUNCTIONS ==========

        function showLoading(show, title = 'Loading Dashboard...', message = 'Fetching data from server') {
            const loadingSection = document.getElementById('loadingSection');
            loadingSection.style.display = show ? 'block' : 'none';

            if (show) {
                document.getElementById('loadingTitle').textContent = title;
                document.getElementById('loadingMessage').textContent = message;
            }
        }
        
        function showLogin() {
            document.getElementById('loginSection').style.display = 'block';
        }
        
        function showError(message) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        // Close modals when clicking outside of them
        window.onclick = function(event) {
            const passwordModal = document.getElementById('passwordModal');
            const firstLoginModal = document.getElementById('firstLoginModal');

            if (event.target === passwordModal) {
                closePasswordModal();
            }
            if (event.target === firstLoginModal && !usedDefaultPassword) {
                closeFirstLoginModal();
            }
        }
    </script>
</body>
</html>
